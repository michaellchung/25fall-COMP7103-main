# ğŸ§  TravelMate AI - å®Œæ•´æ¨ç†æµç¨‹åˆ†æ

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¶é—´**: 2025-11-18  

---

## ğŸ“‹ ç”¨æˆ·æå‡ºçš„æ¨ç†æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥åˆ†æ + éœ€æ±‚è¡¥å…¨ âœ… å·²å®Œæˆ
2. ç¡®è®¤ç”¨æˆ·éœ€æ±‚æ¨¡å‹ âœ… å·²å®Œæˆ
3. ç”Ÿæˆæ”»ç•¥
   3.1 Tool1: è·¨åŸäº¤é€šæŸ¥è¯¢ (é£æœº/ç«è½¦/è‡ªé©¾)
   3.2 Tool2: æ™¯ç‚¹æŸ¥è¯¢ (å‘é‡æ•°æ®åº“ + TopK)
   3.3 Tool3: ç¾é£ŸæŸ¥è¯¢ (æ™¯ç‚¹é™„è¿‘ + TopK)
   3.4 Tool4: ä½å®¿æŸ¥è¯¢ (åŒºåŸŸå†… + TopK)
   3.5 LLMå†³ç­–: æ¯æ—¥è¡Œç¨‹å®‰æ’ (åŸºäºåå¥½/é¢„ç®—/è·ç¦»)
   3.6 Tool5: å¸‚å†…äº¤é€šæŸ¥è¯¢ [å¯é€‰]
```

---

## âœ… å¯è¡Œæ€§åˆ†æ

### **æ€»ä½“è¯„ä»·**: â­â­â­â­â­ **éå¸¸å¯è¡Œï¼**

è¿™ä¸ªæµç¨‹è®¾è®¡éå¸¸åˆç†ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

#### **1. é€»è¾‘æ¸…æ™°** ğŸ¯
- ä»å®è§‚åˆ°å¾®è§‚ï¼šè·¨åŸäº¤é€š â†’ æ™¯ç‚¹ â†’ ç¾é£Ÿ â†’ ä½å®¿ â†’ æ¯æ—¥å®‰æ’
- ç¬¦åˆäººç±»è§„åˆ’æ—…è¡Œçš„è‡ªç„¶æ€ç»´æµç¨‹

#### **2. æ•°æ®é©±åŠ¨** ğŸ“Š
- æ¯ä¸ªå·¥å…·æä¾›ç»“æ„åŒ–æ•°æ®
- LLMåŸºäºçœŸå®æ•°æ®åšå†³ç­–ï¼Œè€Œéå‡­ç©ºç”Ÿæˆ

#### **3. èŒè´£åˆ†æ˜** ğŸ”§
- å·¥å…·è´Ÿè´£æ•°æ®æ£€ç´¢ï¼ˆç¡®å®šæ€§ï¼‰
- LLMè´Ÿè´£å†³ç­–è§„åˆ’ï¼ˆæ™ºèƒ½æ€§ï¼‰
- å……åˆ†å‘æŒ¥å„è‡ªä¼˜åŠ¿

#### **4. å¯æ‰©å±•æ€§å¼º** ğŸš€
- æ¯ä¸ªToolç›¸å¯¹ç‹¬ç«‹
- æ˜“äºå¢åŠ æ–°çš„æ•°æ®æºæˆ–ä¼˜åŒ–ç®—æ³•

---

## ğŸ” è¯¦ç»†æµç¨‹åˆ†æ

### **é˜¶æ®µ1: ç”¨æˆ·è¾“å…¥åˆ†æ** âœ… å·²å®Œæˆ

```python
# backend/agent/dialogue.py
class DialogueManager:
    def process_user_input(self, state, user_input):
        # 1. æå–éœ€æ±‚
        self._extract_requirements(state, user_input)
        
        # 2. æ£€æŸ¥å®Œæ•´æ€§
        if state.user_requirements.is_complete():
            # è¿›å…¥ç¡®è®¤é˜¶æ®µ
            return self._confirm_requirements(state)
        else:
            # è¯¢é—®ç¼ºå¤±ä¿¡æ¯
            return self._ask_missing_info(state)
```

**è¾“å‡º**:
```json
{
  "destination": "æ­å·",
  "departure_city": "åŒ—äº¬",
  "days": 3,
  "budget": 5000,
  "preferences": ["æ–‡åŒ–", "ç¾é£Ÿ"],
  "companions": "æƒ…ä¾£",
  "companions_count": 2,
  "travel_dates": "2025-12-01"
}
```

---

### **é˜¶æ®µ2: ç¡®è®¤éœ€æ±‚æ¨¡å‹** âœ… å·²å®Œæˆ

```python
# backend/agent/dialogue.py
def _is_confirmation(self, user_input: str) -> bool:
    """ä½¿ç”¨LLMæ™ºèƒ½åˆ¤æ–­ç¡®è®¤æ„å›¾"""
    prompt = """åˆ¤æ–­ç”¨æˆ·æ˜¯"ç¡®è®¤"è¿˜æ˜¯"ä¿®æ”¹"..."""
    response = self.llm.chat(prompt, user_input)
    return response.strip().upper() == "YES"
```

**ç”¨æˆ·ç¡®è®¤å** â†’ è¿›å…¥ `generating` é˜¶æ®µ

---

### **é˜¶æ®µ3: ç”Ÿæˆæ”»ç•¥** ğŸ†• æ ¸å¿ƒæµç¨‹

#### **3.1 Tool1: è·¨åŸäº¤é€šæŸ¥è¯¢** â­

**æ¥å£**: `InterCityTransportService.get_transport_options()`

**è¾“å…¥**:
```python
{
  "departure_city": "åŒ—äº¬",
  "destination_city": "æ­å·",
  "travel_date": "2025-12-01",
  "companions_count": 2
}
```

**è¾“å‡º**:
```python
[
  {
    "method": "é£æœº",
    "duration_hours": 2.5,
    "cost_per_person": 800,
    "total_cost": 1600,
    "description": "æœ€å¿«æ·ï¼Œé€‚åˆé•¿é€”",
    "recommendation_score": 0.9
  },
  {
    "method": "é«˜é“",
    "duration_hours": 5.0,
    "cost_per_person": 550,
    "total_cost": 1100,
    "description": "èˆ’é€‚ä¾¿æ·ï¼Œæ€§ä»·æ¯”é«˜",
    "recommendation_score": 0.95
  },
  {
    "method": "è‡ªé©¾",
    "duration_hours": 12.0,
    "cost_per_person": 400,
    "total_cost": 800,
    "description": "è‡ªç”±çµæ´»",
    "recommendation_score": 0.6
  }
]
```

**âœ… å¯è¡Œæ€§**: éå¸¸å¯è¡Œ
- ä½¿ç”¨é«˜å¾·åœ°å›¾APIè·å–è·ç¦»
- è§„åˆ™ä¼°ç®—è´¹ç”¨ï¼ˆé£æœº0.8å…ƒ/kmï¼Œé«˜é“0.5å…ƒ/kmï¼‰
- è¿”å›3ç§æ–¹æ¡ˆä¾›LLMé€‰æ‹©

---

#### **3.2 Tool2: æ™¯ç‚¹æŸ¥è¯¢** â­â­

**æ¥å£**: `RAGRetriever.retrieve_attractions()`

**è¾“å…¥**:
```python
{
  "city": "æ­å·",
  "preferences": ["æ–‡åŒ–", "ç¾é£Ÿ"],
  "top_k": 15,
  "budget_max": 5000
}
```

**å®ç°æ–¹å¼**:

```python
# 1. æ„å»ºæŸ¥è¯¢å‘é‡
query_text = f"æ­å· {' '.join(preferences)}"
query_embedding = openai.Embedding.create(
    model="text-embedding-3-small",
    input=query_text
)

# 2. å‘é‡æ£€ç´¢
results = chroma_collection.query(
    query_embeddings=[query_embedding],
    n_results=top_k,
    where={"city": "æ­å·"}
)

# 3. æ’åº
sorted_results = sorted(
    results,
    key=lambda x: x.rating * 0.4 + x.similarity * 0.6,
    reverse=True
)
```

**è¾“å‡º**:
```python
[
  {
    "id": "hz001",
    "name": "è¥¿æ¹–",
    "category": ["è‡ªç„¶é£å…‰", "æ–‡åŒ–"],
    "rating": 4.8,
    "ticket_price": 0,
    "duration_hours": 3,
    "location": {"lat": 30.2591, "lng": 120.1353, "address": "..."},
    "description": "æ­å·å¿…æ¸¸æ™¯ç‚¹...",
    "tags": ["å¿…æ¸¸", "å…è´¹", "é€‚åˆæ‹ç…§"]
  },
  {
    "id": "hz002",
    "name": "çµéšå¯º",
    "category": ["å†å²æ–‡åŒ–", "å®—æ•™"],
    "rating": 4.7,
    "ticket_price": 75,
    "duration_hours": 2,
    "location": {"lat": 30.2411, "lng": 120.0967, "address": "..."},
    "description": "åƒå¹´å¤åˆ¹...",
    "tags": ["å¿…æ¸¸", "æ–‡åŒ–"]
  },
  // ... å…±15ä¸ªæ™¯ç‚¹
]
```

**âœ… å¯è¡Œæ€§**: éå¸¸å¯è¡Œ
- ChromaDBå‘é‡æ•°æ®åº“å·²æˆç†Ÿ
- OpenAI Embedding APIç¨³å®š
- è¯­ä¹‰æ£€ç´¢æ•ˆæœå¥½

**âš ï¸ æ³¨æ„äº‹é¡¹**:
- éœ€è¦é¢„å…ˆçˆ¬å–200+æ™¯ç‚¹æ•°æ®
- å‘é‡åŒ–å¤„ç†éœ€è¦æ—¶é—´ï¼ˆä¸€æ¬¡æ€§å®Œæˆï¼‰
- APIè°ƒç”¨æœ‰è´¹ç”¨ï¼ˆçº¦$0.0001/1K tokensï¼‰

---

#### **3.3 Tool3: ç¾é£ŸæŸ¥è¯¢** â­â­

**æ¥å£**: `FoodRecommendationService.get_nearby_restaurants()`

**è¾“å…¥**:
```python
# å¯¹æ¯ä¸ªæ™¯ç‚¹æŸ¥è¯¢é™„è¿‘ç¾é£Ÿ
for attraction in attractions:
    restaurants = food_service.get_nearby_restaurants(
        location=attraction.location,
        radius_km=2.0,
        cuisine_type=["æ­å¸®èœ", "å°åƒ"],
        budget_per_person=100,
        top_k=3
    )
```

**å®ç°æ–¹å¼**:

**æ–¹æ¡ˆA: å‘é‡æ•°æ®åº“** (ä½ å»ºè®®çš„)
```python
# 1. æ„å»ºç¾é£Ÿå‘é‡åº“
restaurants_data = [
    {
        "name": "å¤–å©†å®¶",
        "cuisine": "æ­å¸®èœ",
        "description": "ç»å…¸æ­å¸®èœï¼Œè¥¿æ¹–é†‹é±¼ã€ä¸œå¡è‚‰...",
        "location": {"lat": 30.25, "lng": 120.13}
    },
    // ...
]

# 2. å‘é‡åŒ–
for restaurant in restaurants_data:
    embedding = openai.Embedding.create(
        input=f"{restaurant['name']} {restaurant['cuisine']} {restaurant['description']}"
    )
    chroma_collection.add(embedding, restaurant)

# 3. æŸ¥è¯¢
query = f"æ™¯ç‚¹é™„è¿‘ {' '.join(preferences)} ç¾é£Ÿ"
results = chroma_collection.query(query, n_results=top_k)

# 4. è·ç¦»è¿‡æ»¤
nearby = [r for r in results if distance(r.location, attraction.location) < 2.0]
```

**æ–¹æ¡ˆB: é«˜å¾·POIæœç´¢** (æ›´ç®€å•)
```python
# ç›´æ¥è°ƒç”¨é«˜å¾·åœ°å›¾API
url = "https://restapi.amap.com/v3/place/around"
params = {
    "key": AMAP_KEY,
    "location": f"{lng},{lat}",
    "keywords": "é¤å…|ç¾é£Ÿ",
    "radius": 2000,
    "offset": 20
}
response = requests.get(url, params=params)
```

**è¾“å‡º**:
```python
[
  {
    "name": "å¤–å©†å®¶(æ¹–æ»¨åº—)",
    "cuisine_type": "æ­å¸®èœ",
    "rating": 4.5,
    "avg_price": 80,
    "location": {"lat": 30.2591, "lng": 120.1653},
    "distance_km": 0.5,
    "signature_dishes": ["è¥¿æ¹–é†‹é±¼", "ä¸œå¡è‚‰"],
    "tags": ["å¿…åƒ", "ç½‘çº¢åº—"]
  },
  // ... æ¯ä¸ªæ™¯ç‚¹é™„è¿‘3å®¶é¤å…
]
```

**âœ… å¯è¡Œæ€§**: å¯è¡Œ

**æ¨èæ–¹æ¡ˆ**: 
- **çŸ­æœŸ**: ä½¿ç”¨é«˜å¾·POIæœç´¢APIï¼ˆå¿«é€Ÿå®ç°ï¼‰
- **é•¿æœŸ**: çˆ¬å–å¤§ä¼—ç‚¹è¯„æ•°æ® + å‘é‡åº“ï¼ˆæ›´ç²¾å‡†ï¼‰

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**:

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|-----|------|------|--------|
| å‘é‡æ•°æ®åº“ | è¯­ä¹‰ç†è§£å¼ºï¼Œæ¨èç²¾å‡† | éœ€è¦çˆ¬å–æ•°æ®ï¼Œç»´æŠ¤æˆæœ¬é«˜ | â­â­â­ |
| é«˜å¾·POI | å®æ—¶æ•°æ®ï¼Œå…è´¹é¢åº¦å¤§ | ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œæ— è¯„ä»· | â­â­â­â­ |
| æ··åˆæ–¹æ¡ˆ | ç»“åˆä¸¤è€…ä¼˜ç‚¹ | å¤æ‚åº¦é«˜ | â­â­â­â­â­ |

**å»ºè®®**: å…ˆç”¨é«˜å¾·APIå¿«é€Ÿå®ç°ï¼ŒåæœŸå†è¡¥å……å‘é‡åº“ä¼˜åŒ–

---

#### **3.4 Tool4: ä½å®¿æŸ¥è¯¢** â­

**æ¥å£**: `AccommodationService.get_hotels_in_area()`

**è¾“å…¥**:
```python
{
  "city": "æ­å·",
  "poi_list": [
    {"lat": 30.2591, "lng": 120.1353},  # è¥¿æ¹–
    {"lat": 30.2411, "lng": 120.0967},  # çµéšå¯º
    // ... æ‰€æœ‰æ™¯ç‚¹åæ ‡
  ],
  "budget_per_night": 300,
  "nights": 2,
  "companions_count": 2
}
```

**å®ç°æ–¹å¼**:

```python
# 1. è®¡ç®—POIä¸­å¿ƒç‚¹
center_lat = sum([poi["lat"] for poi in poi_list]) / len(poi_list)
center_lng = sum([poi["lng"] for poi in poi_list]) / len(poi_list)

# 2. ç¡®å®šé…’åº—æ¡£æ¬¡
if budget_per_night < 250:
    level = "ç»æµå‹"
elif budget_per_night < 500:
    level = "èˆ’é€‚å‹"
else:
    level = "é«˜æ¡£å‹"

# 3. æŸ¥è¯¢é™„è¿‘é…’åº—ï¼ˆä»æœ¬åœ°æ•°æ®åº“æˆ–é«˜å¾·APIï¼‰
hotels = query_hotels(center, radius=5km, level=level)

# 4. æ’åº
sorted_hotels = sorted(
    hotels,
    key=lambda h: (
        h.rating * 0.3 +
        (1 / h.distance) * 0.25 +
        price_match_score(h.price, budget) * 0.3 +
        facility_score(h.facilities) * 0.15
    ),
    reverse=True
)
```

**è¾“å‡º**:
```python
[
  {
    "name": "å¦‚å®¶é…’åº—(è¥¿æ¹–åº—)",
    "hotel_type": "ç»æµå‹",
    "rating": 4.3,
    "price_per_night": 280,
    "location": {"lat": 30.26, "lng": 120.14},
    "distance_to_center": 1.2,
    "facilities": ["WiFi", "æ—©é¤", "åœè½¦åœº"],
    "total_cost": 560
  },
  // ... Top 5 é…’åº—
]
```

**âœ… å¯è¡Œæ€§**: å¯è¡Œ

**æ•°æ®æ¥æº**:
1. **çˆ¬å–æºç¨‹/å»å“ªå„¿** (æ¨è) - æ¯åŸå¸‚50å®¶é…’åº—
2. **é«˜å¾·POIæœç´¢** (å¤‡é€‰) - å®æ—¶æŸ¥è¯¢

**âš ï¸ æ³¨æ„**: ä¸å»ºè®®ç”¨å‘é‡æ•°æ®åº“ï¼Œå› ä¸ºé…’åº—é€‰æ‹©ä¸»è¦çœ‹ä½ç½®ã€ä»·æ ¼ã€è¯„åˆ†ï¼Œä¸éœ€è¦è¯­ä¹‰ç†è§£

---

#### **3.5 LLMå†³ç­–: æ¯æ—¥è¡Œç¨‹å®‰æ’** â­â­â­ **æ ¸å¿ƒåˆ›æ–°ç‚¹**

**è¿™æ˜¯æ•´ä¸ªæµç¨‹çš„çµé­‚ï¼** ğŸ§ 

**è¾“å…¥**: å‰é¢4ä¸ªToolçš„æ‰€æœ‰æ•°æ®

```python
{
  "user_requirements": {
    "days": 3,
    "budget": 5000,
    "preferences": ["æ–‡åŒ–", "ç¾é£Ÿ"],
    "companions_count": 2
  },
  "transport_options": [...],  # Tool1
  "attractions": [...],         # Tool2 (15ä¸ªæ™¯ç‚¹)
  "restaurants": [...],         # Tool3 (æ¯ä¸ªæ™¯ç‚¹3å®¶é¤å…)
  "hotels": [...]               # Tool4 (5å®¶é…’åº—)
}
```

**Promptè®¾è®¡**:

```python
ITINERARY_PLANNING_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’å¸ˆã€‚æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·åˆ¶å®šä¸€ä»½è¯¦ç»†çš„æ—…è¡Œæ”»ç•¥ã€‚

## ç”¨æˆ·éœ€æ±‚
- ç›®çš„åœ°: {destination}
- å¤©æ•°: {days}å¤©
- é¢„ç®—: {budget}å…ƒ
- åå¥½: {preferences}
- åŒè¡Œ: {companions} ({companions_count}äºº)
- å‡ºå‘åœ°: {departure_city}

## å¯é€‰äº¤é€šæ–¹æ¡ˆ
{transport_options_json}

## å¯é€‰æ™¯ç‚¹ (Top 15)
{attractions_json}

## å¯é€‰é¤å… (æŒ‰æ™¯ç‚¹åˆ†ç»„)
{restaurants_json}

## å¯é€‰é…’åº— (Top 5)
{hotels_json}

## è§„åˆ’è¦æ±‚
1. **äº¤é€šé€‰æ‹©**: ä»3ç§äº¤é€šæ–¹æ¡ˆä¸­é€‰æ‹©1ç§ï¼ˆå¾€è¿”å¯ä»¥ä¸åŒï¼‰ï¼Œè¯´æ˜ç†ç”±
2. **æ™¯ç‚¹å®‰æ’**: 
   - æ¯å¤©å®‰æ’3-4ä¸ªæ™¯ç‚¹
   - ä¼˜å…ˆé€‰æ‹©ç¬¦åˆç”¨æˆ·åå¥½çš„æ™¯ç‚¹
   - åŒä¸€å¤©çš„æ™¯ç‚¹å°½é‡åœ°ç†ä½ç½®æ¥è¿‘ï¼ˆå‡å°‘è·¯ç¨‹ï¼‰
   - è€ƒè™‘æ™¯ç‚¹æ¸¸ç©æ—¶é•¿å’Œå¼€æ”¾æ—¶é—´
3. **é¤é¥®å®‰æ’**:
   - æ¯å¤©å®‰æ’åˆé¤å’Œæ™šé¤
   - é€‰æ‹©æ™¯ç‚¹é™„è¿‘çš„é¤å…
   - æ§åˆ¶åœ¨é¢„ç®—èŒƒå›´å†…
4. **ä½å®¿é€‰æ‹©**:
   - é€‰æ‹©1å®¶é…’åº—ï¼ˆå…¨ç¨‹ä½åŒä¸€å®¶ï¼‰
   - ä½ç½®å°½é‡é è¿‘å¤šæ•°æ™¯ç‚¹
   - ç¬¦åˆé¢„ç®—æ¡£æ¬¡
5. **é¢„ç®—æ§åˆ¶**:
   - äº¤é€šè´¹ + é—¨ç¥¨è´¹ + é¤é¥®è´¹ + ä½å®¿è´¹ â‰¤ æ€»é¢„ç®—
   - å¦‚æœè¶…é¢„ç®—ï¼Œè°ƒæ•´æ™¯ç‚¹æˆ–é¤å…
6. **æ—¶é—´å®‰æ’**:
   - æ¯å¤©09:00å¼€å§‹ï¼Œ21:00ç»“æŸ
   - è€ƒè™‘äº¤é€šæ—¶é—´ã€ç”¨é¤æ—¶é—´ã€ä¼‘æ¯æ—¶é—´

## è¾“å‡ºæ ¼å¼ (JSON)
```json
{
  "transport": {
    "outbound": {
      "method": "é«˜é“",
      "reason": "æ€§ä»·æ¯”é«˜ï¼Œæ—¶é—´é€‚ä¸­"
    },
    "return": {
      "method": "é£æœº",
      "reason": "æœ€åä¸€å¤©èŠ‚çœæ—¶é—´"
    }
  },
  "hotel": {
    "name": "å¦‚å®¶é…’åº—(è¥¿æ¹–åº—)",
    "reason": "ä½ç½®ä¸­å¿ƒï¼Œæ€§ä»·æ¯”é«˜"
  },
  "daily_plans": [
    {
      "day": 1,
      "date": "2025-12-01",
      "theme": "è¥¿æ¹–æ–‡åŒ–ä¹‹æ—…",
      "schedule": [
        {
          "time": "09:00-12:00",
          "type": "æ™¯ç‚¹",
          "name": "è¥¿æ¹–",
          "reason": "æ­å·å¿…æ¸¸ï¼Œå…è´¹æ™¯ç‚¹"
        },
        {
          "time": "12:00-13:30",
          "type": "åˆé¤",
          "name": "å¤–å©†å®¶",
          "reason": "è¥¿æ¹–é™„è¿‘ï¼Œæ€§ä»·æ¯”é«˜"
        },
        {
          "time": "14:00-17:00",
          "type": "æ™¯ç‚¹",
          "name": "é›·å³°å¡”",
          "reason": "è¥¿æ¹–è¾¹ï¼Œæ–‡åŒ–æ™¯ç‚¹"
        },
        {
          "time": "18:00-19:30",
          "type": "æ™šé¤",
          "name": "æ¥¼å¤–æ¥¼",
          "reason": "æ­å¸®èœè€å­—å·"
        }
      ],
      "daily_cost": 800
    },
    // ... Day 2, Day 3
  ],
  "budget_breakdown": {
    "transport": 1650,
    "attractions": 450,
    "food": 1200,
    "accommodation": 560,
    "misc": 500,
    "total": 4360
  },
  "tips": [
    "å»ºè®®æå‰é¢„è®¢é«˜é“ç¥¨",
    "è¥¿æ¹–å‘¨è¾¹å¯ç§Ÿè‡ªè¡Œè½¦æ¸¸è§ˆ",
    "é›·å³°å¡”å»ºè®®å‚æ™šæ¸¸è§ˆï¼Œå¯çœ‹æ—¥è½"
  ]
}
```

è¯·ä¸¥æ ¼æŒ‰ç…§JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ å…¶ä»–å†…å®¹ã€‚
"""
```

**LLMè°ƒç”¨**:

```python
# backend/planner/itinerary_generator.py
class ItineraryGenerator:
    def generate_itinerary_with_llm(
        self,
        user_requirements: UserRequirements,
        transport_options: List[TransportOption],
        attractions: List[Attraction],
        restaurants: Dict[str, List[Restaurant]],
        hotels: List[Hotel]
    ) -> Dict:
        """ä½¿ç”¨LLMç”Ÿæˆè¡Œç¨‹"""
        
        # 1. æ„å»ºPrompt
        prompt = ITINERARY_PLANNING_PROMPT.format(
            destination=user_requirements.destination,
            days=user_requirements.days,
            budget=user_requirements.budget,
            preferences=", ".join(user_requirements.preferences),
            companions=user_requirements.companions,
            companions_count=user_requirements.companions_count,
            departure_city=user_requirements.departure_city,
            transport_options_json=json.dumps(transport_options, ensure_ascii=False, indent=2),
            attractions_json=json.dumps(attractions, ensure_ascii=False, indent=2),
            restaurants_json=json.dumps(restaurants, ensure_ascii=False, indent=2),
            hotels_json=json.dumps(hotels, ensure_ascii=False, indent=2)
        )
        
        # 2. è°ƒç”¨LLM
        response = self.llm.chat(prompt, "")
        
        # 3. è§£æJSON
        itinerary = json.loads(response)
        
        # 4. éªŒè¯å’Œä¼˜åŒ–
        itinerary = self._validate_and_optimize(itinerary, user_requirements)
        
        return itinerary
```

**âœ… å¯è¡Œæ€§**: éå¸¸å¯è¡Œï¼

**ä¼˜åŠ¿**:
1. **æ™ºèƒ½å†³ç­–**: LLMå¯ä»¥ç»¼åˆè€ƒè™‘å¤šä¸ªå› ç´ ï¼ˆåå¥½ã€é¢„ç®—ã€è·ç¦»ã€æ—¶é—´ï¼‰
2. **çµæ´»æ€§å¼º**: å¯ä»¥å¤„ç†å„ç§ç‰¹æ®Šéœ€æ±‚å’Œçº¦æŸ
3. **å¯è§£é‡Šæ€§**: LLMä¼šç»™å‡ºé€‰æ‹©ç†ç”±
4. **æ˜“äºä¼˜åŒ–**: é€šè¿‡è°ƒæ•´Promptå³å¯æ”¹è¿›æ•ˆæœ

**âš ï¸ æ³¨æ„äº‹é¡¹**:
1. **Tokené™åˆ¶**: è¾“å…¥æ•°æ®å¯èƒ½å¾ˆå¤§ï¼Œéœ€è¦æ§åˆ¶åœ¨æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£å†…
   - GPT-4: 128K tokens
   - Claude: 200K tokens
   - Llama 8B: 8K tokens âš ï¸ å¯èƒ½ä¸å¤Ÿ
   
2. **è§£å†³æ–¹æ¡ˆ**:
   - **æ–¹æ¡ˆA**: é¢„ç­›é€‰æ•°æ®ï¼ˆåªä¼ Top 10æ™¯ç‚¹ï¼Œæ¯æ™¯ç‚¹2å®¶é¤å…ï¼‰
   - **æ–¹æ¡ˆB**: åˆ†æ­¥å†³ç­–ï¼ˆå…ˆé€‰æ™¯ç‚¹ï¼Œå†é€‰é¤å…ï¼Œæœ€åé€‰é…’åº—ï¼‰
   - **æ–¹æ¡ˆC**: ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼ˆGPT-4 / Claudeï¼‰

3. **JSONè§£æå¤±è´¥**: LLMå¯èƒ½è¿”å›éæ ‡å‡†JSON
   - ä½¿ç”¨ `extract_json()` æ–¹æ³•æå–
   - æ·»åŠ é‡è¯•æœºåˆ¶

---

#### **3.6 Tool5: å¸‚å†…äº¤é€šæŸ¥è¯¢** [å¯é€‰] â­

**æ¥å£**: `IntraCityRouteOptimizer.optimize_daily_route()`

**è¾“å…¥**:
```python
{
  "hotel_location": {"lat": 30.26, "lng": 120.14},
  "attractions": [
    {"name": "è¥¿æ¹–", "location": {...}, "duration": 3},
    {"name": "é›·å³°å¡”", "location": {...}, "duration": 2}
  ],
  "restaurants": [
    {"name": "å¤–å©†å®¶", "location": {...}}
  ]
}
```

**å®ç°æ–¹å¼**:

```python
# 1. TSPè·¯çº¿ä¼˜åŒ–
route = optimize_route_tsp(hotel, attractions, restaurants)

# 2. è°ƒç”¨é«˜å¾·åœ°å›¾APIè·å–äº¤é€šæ–¹å¼
for i in range(len(route) - 1):
    from_poi = route[i]
    to_poi = route[i + 1]
    
    # é«˜å¾·è·¯å¾„è§„åˆ’API
    url = "https://restapi.amap.com/v3/direction/transit/integrated"
    params = {
        "key": AMAP_KEY,
        "origin": f"{from_poi['lng']},{from_poi['lat']}",
        "destination": f"{to_poi['lng']},{to_poi['lat']}",
        "city": "æ­å·"
    }
    response = requests.get(url, params=params)
    
    # è§£æäº¤é€šæ–¹æ¡ˆ
    transit_info = parse_transit_response(response.json())
    route[i]["transport_to_next"] = transit_info
```

**è¾“å‡º**:
```python
{
  "day": 1,
  "schedule": [
    {
      "time": "09:00",
      "poi": "é…’åº—",
      "transport_to_next": {
        "method": "åœ°é“1å·çº¿",
        "duration": 15,
        "cost": 3
      }
    },
    {
      "time": "09:30",
      "poi": "è¥¿æ¹–",
      "duration": 180,
      "transport_to_next": {
        "method": "æ­¥è¡Œ",
        "duration": 10,
        "cost": 0
      }
    },
    // ...
  ]
}
```

**âœ… å¯è¡Œæ€§**: å¯è¡Œä½†éå¿…éœ€

**å»ºè®®**: 
- **P2ä¼˜å…ˆçº§**ï¼Œæ—¶é—´å……è£•å†åš
- å¯ä»¥å…ˆç”¨ç®€å•è§„åˆ™ï¼ˆè·ç¦»<1.5kmæ­¥è¡Œï¼Œå¦åˆ™åœ°é“ï¼‰

---

## ğŸ”„ å®Œæ•´æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è¾“å…¥                                   â”‚
â”‚  "æˆ‘æƒ³ä»åŒ—äº¬å»æ­å·ç©3å¤©ï¼Œé¢„ç®—5000ï¼Œå–œæ¬¢æ–‡åŒ–å’Œç¾é£Ÿ"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 1: éœ€æ±‚æå– (LLM)                          â”‚
â”‚  - ç›®çš„åœ°: æ­å·                                               â”‚
â”‚  - å‡ºå‘åœ°: åŒ—äº¬                                               â”‚
â”‚  - å¤©æ•°: 3å¤©                                                  â”‚
â”‚  - é¢„ç®—: 5000å…ƒ                                               â”‚
â”‚  - åå¥½: [æ–‡åŒ–, ç¾é£Ÿ]                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 2: éœ€æ±‚ç¡®è®¤ (LLM)                          â”‚
â”‚  ç”¨æˆ·: "æ˜¯çš„ï¼Œæ­£ç¡®"                                           â”‚
â”‚  LLMåˆ¤æ–­: YES â†’ è¿›å…¥ç”Ÿæˆé˜¶æ®µ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 3.1: Tool1 è·¨åŸäº¤é€š                         â”‚
â”‚  è¾“å…¥: åŒ—äº¬ â†’ æ­å·, 2äºº                                       â”‚
â”‚  è¾“å‡º: [é£æœº:1600å…ƒ, é«˜é“:1100å…ƒ, è‡ªé©¾:800å…ƒ]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 3.2: Tool2 æ™¯ç‚¹æŸ¥è¯¢ (RAG)                   â”‚
â”‚  è¾“å…¥: æ­å· + [æ–‡åŒ–, ç¾é£Ÿ] + Top15                            â”‚
â”‚  å‘é‡æ£€ç´¢: ChromaDB                                           â”‚
â”‚  è¾“å‡º: [è¥¿æ¹–, çµéšå¯º, é›·å³°å¡”, æ²³åŠè¡—, ...]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 3.3: Tool3 ç¾é£ŸæŸ¥è¯¢                         â”‚
â”‚  è¾“å…¥: 15ä¸ªæ™¯ç‚¹åæ ‡ + åŠå¾„2km                                 â”‚
â”‚  æ–¹å¼: é«˜å¾·POIæœç´¢ / å‘é‡æ•°æ®åº“                               â”‚
â”‚  è¾“å‡º: {                                                      â”‚
â”‚    "è¥¿æ¹–": [å¤–å©†å®¶, æ¥¼å¤–æ¥¼, çŸ¥å‘³è§‚],                          â”‚
â”‚    "çµéšå¯º": [çµéšç´ æ–‹, é¾™äº•èŒ¶å®¤, ...],                       â”‚
â”‚    ...                                                        â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 3.4: Tool4 ä½å®¿æŸ¥è¯¢                         â”‚
â”‚  è¾“å…¥: 15ä¸ªæ™¯ç‚¹åæ ‡ â†’ è®¡ç®—ä¸­å¿ƒç‚¹                              â”‚
â”‚  æŸ¥è¯¢: ä¸­å¿ƒç‚¹5kmå†… + é¢„ç®—300å…ƒ/æ™š                             â”‚
â”‚  è¾“å‡º: [å¦‚å®¶é…’åº—, æ±‰åº­é…’åº—, 7å¤©é…’åº—, ...]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 3.5: LLMå†³ç­– (æ ¸å¿ƒ)                         â”‚
â”‚                                                               â”‚
â”‚  è¾“å…¥: æ‰€æœ‰Toolæ•°æ® (äº¤é€š+æ™¯ç‚¹+ç¾é£Ÿ+é…’åº—)                      â”‚
â”‚                                                               â”‚
â”‚  Prompt: "ä½ æ˜¯ä¸“ä¸šæ—…è¡Œè§„åˆ’å¸ˆï¼Œæ ¹æ®ä»¥ä¸‹æ•°æ®åˆ¶å®šè¡Œç¨‹..."         â”‚
â”‚                                                               â”‚
â”‚  LLMæ¨ç†:                                                     â”‚
â”‚  1. åˆ†æç”¨æˆ·åå¥½ â†’ ä¼˜å…ˆé€‰"æ–‡åŒ–"å’Œ"ç¾é£Ÿ"ç›¸å…³æ™¯ç‚¹               â”‚
â”‚  2. è€ƒè™‘é¢„ç®—çº¦æŸ â†’ é€‰é«˜é“(1100) + ç»æµå‹é…’åº—(560)             â”‚
â”‚  3. ä¼˜åŒ–åœ°ç†ä½ç½® â†’ Day1è¥¿æ¹–å‘¨è¾¹, Day2çµéšå‘¨è¾¹                 â”‚
â”‚  4. å¹³è¡¡æ—¶é—´å®‰æ’ â†’ æ¯å¤©3-4ä¸ªæ™¯ç‚¹ï¼Œä¸è¿‡åº¦ç–²åŠ³                  â”‚
â”‚                                                               â”‚
â”‚  è¾“å‡º: å®Œæ•´JSONè¡Œç¨‹                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Step 3.6: Tool5 å¸‚å†…äº¤é€š [å¯é€‰]                  â”‚
â”‚  è¾“å…¥: æ¯æ—¥POIåˆ—è¡¨                                            â”‚
â”‚  ä¼˜åŒ–: TSPç®—æ³• + é«˜å¾·è·¯å¾„è§„åˆ’                                 â”‚
â”‚  è¾“å‡º: è¯¦ç»†äº¤é€šæ–¹æ¡ˆ (åœ°é“/å…¬äº¤/æ­¥è¡Œ)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æœ€ç»ˆè¡Œç¨‹è¾“å‡º                                 â”‚
â”‚                                                               â”‚
â”‚  {                                                            â”‚
â”‚    "transport": {...},                                        â”‚
â”‚    "hotel": {...},                                            â”‚
â”‚    "daily_plans": [                                           â”‚
â”‚      {                                                        â”‚
â”‚        "day": 1,                                              â”‚
â”‚        "theme": "è¥¿æ¹–æ–‡åŒ–ä¹‹æ—…",                                â”‚
â”‚        "schedule": [                                          â”‚
â”‚          {time: "09:00", poi: "è¥¿æ¹–", ...},                   â”‚
â”‚          {time: "12:00", poi: "å¤–å©†å®¶", ...},                 â”‚
â”‚          ...                                                  â”‚
â”‚        ]                                                      â”‚
â”‚      },                                                       â”‚
â”‚      ...                                                      â”‚
â”‚    ],                                                         â”‚
â”‚    "budget_breakdown": {...},                                 â”‚
â”‚    "tips": [...]                                              â”‚
â”‚  }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### **1. Tokenä¼˜åŒ–** âš ï¸ é‡è¦

**é—®é¢˜**: 15ä¸ªæ™¯ç‚¹ Ã— 3å®¶é¤å… = 45å®¶é¤å…ï¼Œæ•°æ®é‡å¤§

**è§£å†³æ–¹æ¡ˆ**:

```python
# æ–¹æ¡ˆA: é¢„ç­›é€‰
attractions = rag_retriever.retrieve_attractions(top_k=10)  # å‡å°‘åˆ°10ä¸ª
restaurants_per_attraction = 2  # æ¯ä¸ªæ™¯ç‚¹åªæ¨è2å®¶

# æ–¹æ¡ˆB: åˆ†æ­¥å†³ç­–
# Step 1: LLMå…ˆé€‰æ™¯ç‚¹
selected_attractions = llm.select_attractions(attractions, days=3)

# Step 2: åªæŸ¥è¯¢é€‰ä¸­æ™¯ç‚¹çš„é¤å…
for attraction in selected_attractions:
    restaurants[attraction.name] = food_service.get_nearby(attraction, top_k=2)

# Step 3: LLMå†å®‰æ’è¯¦ç»†è¡Œç¨‹
itinerary = llm.plan_detailed_schedule(selected_attractions, restaurants, hotels)
```

**æ¨è**: æ–¹æ¡ˆBï¼ˆåˆ†æ­¥å†³ç­–ï¼‰ï¼Œæ›´çµæ´»ä¸”èŠ‚çœToken

---

### **2. ç¼“å­˜æœºåˆ¶** ğŸ’¾

```python
# ç¼“å­˜Toolç»“æœï¼Œé¿å…é‡å¤è°ƒç”¨
import functools
from cachetools import TTLCache

cache = TTLCache(maxsize=100, ttl=3600)  # 1å°æ—¶ç¼“å­˜

@functools.lru_cache(maxsize=128)
def get_transport_options(departure, destination):
    # ...
    pass

@cache.cached(key=lambda city, prefs: f"{city}_{','.join(prefs)}")
def retrieve_attractions(city, preferences):
    # ...
    pass
```

---

### **3. å¹¶è¡Œè°ƒç”¨** âš¡

```python
import asyncio

async def generate_itinerary_parallel(user_requirements):
    # å¹¶è¡Œè°ƒç”¨Tool1-4
    transport_task = asyncio.create_task(get_transport_options(...))
    attractions_task = asyncio.create_task(retrieve_attractions(...))
    
    # ç­‰å¾…æ™¯ç‚¹ç»“æœåå†æŸ¥ç¾é£Ÿ
    attractions = await attractions_task
    restaurants_task = asyncio.create_task(get_restaurants_for_attractions(attractions))
    hotels_task = asyncio.create_task(get_hotels(...))
    
    # ç­‰å¾…æ‰€æœ‰ç»“æœ
    transport = await transport_task
    restaurants = await restaurants_task
    hotels = await hotels_task
    
    # LLMå†³ç­–
    itinerary = await llm_plan(transport, attractions, restaurants, hotels)
    
    return itinerary
```

**æ€§èƒ½æå‡**: ä»ä¸²è¡Œ10ç§’ â†’ å¹¶è¡Œ3ç§’

---

### **4. é”™è¯¯å¤„ç†** ğŸ›¡ï¸

```python
def generate_itinerary_with_fallback(user_requirements):
    try:
        # å°è¯•å®Œæ•´æµç¨‹
        return generate_itinerary_full(user_requirements)
    except TokenLimitError:
        # Tokenè¶…é™ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆ
        logger.warning("Tokenè¶…é™ï¼Œä½¿ç”¨ç®€åŒ–æµç¨‹")
        return generate_itinerary_simplified(user_requirements)
    except LLMParseError:
        # LLMè¿”å›æ ¼å¼é”™è¯¯ï¼Œé‡è¯•
        logger.warning("LLMè§£æå¤±è´¥ï¼Œé‡è¯•")
        return generate_itinerary_with_retry(user_requirements)
    except Exception as e:
        # å…œåº•ï¼šè¿”å›è§„åˆ™ç”Ÿæˆçš„è¡Œç¨‹
        logger.error(f"ç”Ÿæˆå¤±è´¥: {e}ï¼Œä½¿ç”¨è§„åˆ™å…œåº•")
        return generate_itinerary_rule_based(user_requirements)
```

---

## ğŸ“Š æ€§èƒ½è¯„ä¼°

### **æ—¶é—´ä¼°ç®—**

| æ­¥éª¤ | è€—æ—¶ | ä¼˜åŒ–å |
|-----|------|--------|
| Tool1 è·¨åŸäº¤é€š | 0.5s | 0.5s |
| Tool2 æ™¯ç‚¹RAG | 1.0s | 0.3s (ç¼“å­˜) |
| Tool3 ç¾é£ŸæŸ¥è¯¢ | 2.0s | 0.5s (å¹¶è¡Œ) |
| Tool4 ä½å®¿æŸ¥è¯¢ | 0.5s | 0.5s |
| LLMå†³ç­– | 5-10s | 5-10s |
| **æ€»è®¡** | **9-14s** | **7-12s** |

### **æˆæœ¬ä¼°ç®—**

| é¡¹ç›® | å•æ¬¡æˆæœ¬ | æœˆæˆæœ¬(1000ç”¨æˆ·) |
|-----|---------|-----------------|
| OpenAI Embedding | $0.002 | $2 |
| GPT-4 å†³ç­– | $0.05 | $50 |
| é«˜å¾·åœ°å›¾API | $0 | $0 (å…è´¹é¢åº¦) |
| **æ€»è®¡** | **$0.052** | **$52** |

---

## âœ… æœ€ç»ˆè¯„ä»·

### **å¯è¡Œæ€§**: â­â­â­â­â­ éå¸¸å¯è¡Œï¼

### **ä¼˜ç‚¹**:
1. âœ… é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºå®ç°
2. âœ… æ•°æ®é©±åŠ¨ï¼Œç»“æœå¯é 
3. âœ… LLMå†³ç­–ï¼Œæ™ºèƒ½çµæ´»
4. âœ… æ¨¡å—ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤

### **æŒ‘æˆ˜**:
1. âš ï¸ Tokené™åˆ¶ï¼ˆéœ€è¦ä¼˜åŒ–ï¼‰
2. âš ï¸ æ•°æ®çˆ¬å–ï¼ˆéœ€è¦æ—¶é—´ï¼‰
3. âš ï¸ LLMæˆæœ¬ï¼ˆéœ€è¦æ§åˆ¶ï¼‰

### **å»ºè®®ä¼˜å…ˆçº§**:

**P0 (å¿…é¡»)**:
- âœ… Tool1: è·¨åŸäº¤é€šï¼ˆè§„åˆ™ä¼°ç®—ï¼‰
- âœ… Tool2: æ™¯ç‚¹RAGï¼ˆå‘é‡æ£€ç´¢ï¼‰
- âœ… Tool4: ä½å®¿æŸ¥è¯¢ï¼ˆæœ¬åœ°æ•°æ®ï¼‰
- âœ… LLMå†³ç­–ï¼ˆæ ¸å¿ƒï¼‰

**P1 (é‡è¦)**:
- ğŸ”„ Tool3: ç¾é£ŸæŸ¥è¯¢ï¼ˆé«˜å¾·APIï¼‰
- ğŸ”„ Tokenä¼˜åŒ–ï¼ˆåˆ†æ­¥å†³ç­–ï¼‰
- ğŸ”„ ç¼“å­˜æœºåˆ¶

**P2 (å¯é€‰)**:
- ğŸ”„ Tool5: å¸‚å†…äº¤é€š
- ğŸ”„ ç¾é£Ÿå‘é‡åº“
- ğŸ”„ å¹¶è¡Œè°ƒç”¨

---

## ğŸš€ å®æ–½å»ºè®®

### **ç¬¬ä¸€é˜¶æ®µ (Day 1-3)**: æ ¸å¿ƒæµç¨‹
1. å®ç°Tool1ã€Tool2ã€Tool4ï¼ˆä½¿ç”¨ç®€åŒ–æ•°æ®ï¼‰
2. è®¾è®¡LLMå†³ç­–Prompt
3. æ‰“é€šç«¯åˆ°ç«¯æµç¨‹

### **ç¬¬äºŒé˜¶æ®µ (Day 4-6)**: æ•°æ®å®Œå–„
1. çˆ¬å–æ™¯ç‚¹æ•°æ® â†’ å‘é‡åŒ–
2. çˆ¬å–é…’åº—æ•°æ®
3. é›†æˆé«˜å¾·ç¾é£ŸAPI

### **ç¬¬ä¸‰é˜¶æ®µ (Day 7-9)**: ä¼˜åŒ–æå‡
1. Tokenä¼˜åŒ–ï¼ˆåˆ†æ­¥å†³ç­–ï¼‰
2. æ·»åŠ ç¼“å­˜
3. é”™è¯¯å¤„ç†

### **ç¬¬å››é˜¶æ®µ (Day 10)**: æµ‹è¯•ä¸Šçº¿
1. ç«¯åˆ°ç«¯æµ‹è¯•
2. å‰ç«¯è”è°ƒ
3. æ€§èƒ½ä¼˜åŒ–

---

**æ€»ç»“**: ä½ çš„æ¨ç†æµç¨‹éå¸¸åˆç†ä¸”å¯è¡Œï¼å»ºè®®æŒ‰ç…§P0â†’P1â†’P2çš„ä¼˜å…ˆçº§é€æ­¥å®ç°ã€‚æ ¸å¿ƒæ˜¯**LLMå†³ç­–**è¿™ä¸€æ­¥ï¼Œå®ƒå°†æ‰€æœ‰æ•°æ®æ•´åˆèµ·æ¥ï¼Œç”Ÿæˆæ™ºèƒ½åŒ–çš„è¡Œç¨‹å®‰æ’ã€‚ğŸ‰

