# 用户需求模型更新说明 v1.2

## 📋 更新概述

**更新时间**: 2025-11-18  
**版本**: v1.2  
**更新内容**: 新增**出发地**和**同行人数**字段

---

## ✨ 新增字段

### 1. **出发地** (`departure_city`)
- **类型**: `Optional[str]`
- **说明**: 用户的出发城市
- **示例**: "上海"、"北京"、"深圳"
- **用途**: 
  - 计算往返交通费用（高铁/飞机）
  - 规划出发和返程路线
  - 估算总体行程时间

### 2. **同行人数** (`companions_count`)
- **类型**: `Optional[int]`
- **说明**: 出行总人数（包括用户自己）
- **示例**: 2（情侣）、3（三口之家）、4（朋友团）
- **用途**:
  - 调整预算（家庭3人以上增加15%，朋友4人以上优惠10%）
  - 推荐适合人数的餐厅和酒店
  - 优化团体购票方案

---

## 🔄 更新的文件列表

### **后端文件** (5个)

1. **`backend/agent/state.py`**
   - 在 `UserRequirements` 模型中新增两个字段
   ```python
   departure_city: Optional[str] = None  # 出发地
   companions_count: Optional[int] = None  # 同行人数
   ```

2. **`backend/agent/dialogue.py`**
   - 更新 `_extract_requirements()`: 提取出发地和人数
   - 更新 `_ask_missing_info()`: 询问出发地和人数
   - 更新 `_confirm_requirements()`: 确认时显示出发地和人数
   - 新增提问:
     - "🚄 您从哪个城市出发？"
     - "🔢 一共几个人出行？（包括您自己）"

3. **`backend/config/prompts.py`**
   - 更新 `EXTRACTION_PROMPT`: 让LLM识别出发地和人数
   - 新增提取规则:
     - `departure_city`: 出发地城市
     - `companions_count`: 出行人数（"我们两个人"→2，"三口之家"→3）

4. **`backend/planner/itinerary_generator.py`**
   - `generate_itinerary()` 方法新增两个参数
   - `_adjust_for_companions()` 方法根据人数动态调整预算:
     - 家庭3人以上: 预算+15%
     - 朋友4人以上: 预算-10%（团体优惠）
   - 行程返回数据中包含出发地和人数

5. **`backend/agent/core.py`**
   - `_generate_itinerary()` 方法传递新字段给行程生成器

### **前端文件** (1个)

6. **`frontend/src/views/ChatView.vue`**
   - **侧边栏**: 显示出发地和人数
   ```html
   <div class="requirement-item" v-if="requirements.departure_city">
     <span class="label">🚄 出发地:</span>
     <span class="value">{{ requirements.departure_city }}</span>
   </div>
   <div class="requirement-item" v-if="requirements.companions_count">
     <span class="label">🔢 人数:</span>
     <span class="value">{{ requirements.companions_count }}人</span>
   </div>
   ```
   
   - **行程详情卡片**: 显示出发地和人数
   ```html
   <div class="info-item" v-if="message.itinerary.departure_city">
     <span class="label">🚄 出发地:</span>
     <span class="value">{{ message.itinerary.departure_city }}</span>
   </div>
   <div class="info-item" v-if="message.itinerary.companions_count">
     <span class="label">🔢 人数:</span>
     <span class="value">{{ message.itinerary.companions_count }}人</span>
   </div>
   ```

---

## 💬 对话示例

### **示例1: 完整信息提取**

**用户**: "我想从上海出发去杭州玩三天，我们一家三口，预算5000元，喜欢文化和美食"

**系统提取**:
```json
{
  "destination": "杭州",
  "departure_city": "上海",
  "days": 3,
  "budget": 5000,
  "preferences": ["文化", "美食"],
  "companions": "家庭",
  "companions_count": 3
}
```

**预算调整**: 5000 × 1.15 = 5750元（家庭3人增加15%）

---

### **示例2: 分步收集**

**用户**: "我想去杭州玩三天"

**Agent**: 
```
好的！杭州是个不错的选择！✨

为了给您制定更合适的行程，我需要了解一些信息...
请问：
1. 🚄 您从哪个城市出发？
2. 💰 大概的预算范围是多少？
3. 🎯 您对哪些方面比较感兴趣？（美食/文化/自然/休闲）
4. 👥 您是独行还是和谁一起出行？（独行/情侣/家庭/朋友）
5. 🔢 一共几个人出行？（包括您自己）
```

**用户**: "从北京出发，我们两个人，预算3000，喜欢自然风光"

**系统提取**:
```json
{
  "destination": "杭州",
  "departure_city": "北京",
  "days": 3,
  "budget": 3000,
  "preferences": ["自然"],
  "companions": "情侣",
  "companions_count": 2
}
```

---

## 🎯 预算调整规则

| 同行类型 | 人数条件 | 预算调整 | 原因 |
|---------|---------|---------|------|
| **家庭** | ≥3人 | +15% | 儿童活动、家庭套餐 |
| **家庭** | <3人 | +10% | 儿童相关费用 |
| **情侣** | - | -5% | 双人优惠 |
| **朋友** | ≥4人 | -10% | 团体购票优惠 |
| **朋友** | <4人 | 无调整 | - |
| **独行** | - | 无调整 | - |

---

## 🔍 数据流转

```
用户输入
  ↓
LLM提取 (dialogue.py)
  ↓
更新UserRequirements (state.py)
  ↓
传递给行程生成器 (core.py)
  ↓
预算调整 (itinerary_generator.py)
  ↓
生成行程
  ↓
返回前端展示 (ChatView.vue)
```

---

## 📊 完整字段列表

| 字段 | 类型 | 必填 | 说明 | 新增 |
|-----|------|------|------|------|
| `destination` | str | ✅ | 目的地城市 | - |
| `province` | str | - | 省份（自动推断） | - |
| `departure_city` | str | - | 出发地城市 | ✅ v1.2 |
| `days` | int | ✅ | 旅行天数 | - |
| `budget` | int | ✅ | 总预算（元） | - |
| `travel_dates` | str | - | 出行日期 | - |
| `preferences` | List[str] | ✅ | 旅行偏好 | - |
| `companions` | str | - | 同行类型 | v1.1 |
| `companions_count` | int | - | 同行人数 | ✅ v1.2 |
| `special_needs` | str | - | 特殊需求 | - |

---

## ✅ 测试建议

### **测试用例1: 家庭出游**
```
输入: "我们一家四口从深圳去杭州玩5天，预算8000元，喜欢自然和文化"
预期: 
- companions_count = 4
- departure_city = "深圳"
- 预算调整为 8000 × 1.15 = 9200元
```

### **测试用例2: 朋友团**
```
输入: "我和5个朋友从上海去苏州玩3天，预算6000，喜欢美食"
预期:
- companions_count = 6
- companions = "朋友"
- 预算调整为 6000 × 0.9 = 5400元（团体优惠）
```

### **测试用例3: 情侣游**
```
输入: "我和女朋友从广州去杭州玩4天，预算5000"
预期:
- companions_count = 2
- companions = "情侣"
- 预算调整为 5000 × 0.95 = 4750元
```

---

## 🚀 后续优化方向

1. **交通费用计算** ⭐
   - 根据出发地和目的地计算高铁/飞机费用
   - 集成12306或携程API获取实时票价

2. **团体优惠推荐**
   - 4人以上推荐团体票景点
   - 推荐适合多人的餐厅和酒店

3. **出发地相关建议**
   - 根据距离推荐交通方式
   - 计算最佳出发时间

4. **人数相关优化**
   - 推荐适合人数的活动
   - 酒店房间数量计算（2人/间）

---

## 📝 版本历史

- **v1.2** (2025-11-18): 新增出发地和同行人数字段
- **v1.1** (2025-11-17): 新增同行类型字段
- **v1.0** (2025-11-15): 初始版本

---

**更新完成！** 🎉

现在系统可以更智能地收集用户的出发地和同行人数信息，并根据这些信息动态调整预算和推荐策略。

