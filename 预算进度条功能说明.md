# 预算进度条功能说明

## 📋 功能概述

在每个选择器组件（交通、景点、美食、住宿）中添加了实时预算进度条，用户可以在选择过程中实时看到预算使用情况和剩余预算。

---

## ✨ 核心功能

### 1. 实时预算追踪
- ✅ 显示总预算和已使用预算
- ✅ 显示剩余预算
- ✅ 显示使用比例（百分比）
- ✅ 分类显示：交通、景点、美食、住宿

### 2. 预览功能
- ✅ 选择选项时，实时预览该选项对预算的影响
- ✅ 未确认前，显示为预览状态
- ✅ 确认后，更新实际预算使用

### 3. 视觉反馈
- ✅ 进度条颜色：
  - 绿色：使用 < 60%
  - 橙色：使用 60-85%
  - 红色：使用 > 85%
- ✅ 剩余预算颜色：
  - 绿色：充足（> 15%）
  - 黄色：紧张（< 15%）
  - 红色：超支（< 0）

---

## 🏗️ 技术实现

### 1. Store状态管理（`stores/chat.js`）

#### 新增状态
```javascript
budgetTracking: {
  total: 0,           // 总预算
  used: 0,            // 已使用
  transport: 0,       // 交通费用
  attractions: 0,     // 景点费用
  food: 0,            // 餐饮费用
  accommodation: 0    // 住宿费用
}
```

#### 计算属性
```javascript
budgetRemaining      // 剩余预算
budgetPercentage     // 使用百分比
budgetStatus         // 状态：success/warning/danger
```

#### 方法
```javascript
updateBudget(category, amount)  // 更新分类预算
```

---

### 2. BudgetProgress组件

#### Props
```javascript
{
  total: Number,          // 总预算（必需）
  used: Number,           // 已使用
  transport: Number,      // 交通费用
  attractions: Number,    // 景点费用
  food: Number,           // 美食费用
  accommodation: Number,  // 住宿费用
  showBreakdown: Boolean  // 是否显示明细
}
```

#### 特性
- 🎨 紫色渐变背景
- 📊 Element Plus进度条
- 💰 金色高亮数字
- 📋 可选费用明细

---

### 3. 各选择器组件集成

#### TransportSelector（交通选择器）

**预览逻辑**：
```javascript
previewTransportCost = selectedOption?.total_cost || currentTransportCost
```

**更新时机**：
- 用户点击交通卡片 → 预览费用变化
- 用户点击"确认选择" → 更新实际预算

**费用计算**：
```javascript
总费用 = option.total_cost  // 往返总费用
```

---

#### AttractionsSelector（景点选择器）

**预览逻辑**：
```javascript
previewAttractionsCost = sum(所有景点的ticket_price)
```

**更新时机**：
- 组件加载 → 自动计算所有景点门票总和
- 用户点击"确认安排" → 更新实际预算

**费用计算**：
```javascript
总费用 = Σ(每个景点的门票价格)
```

---

#### FoodSelector（美食选择器）

**预览逻辑**：
```javascript
previewFoodCost = sum(所有餐厅的avg_price * companions_count)
```

**更新时机**：
- 组件加载 → 自动计算所有餐厅费用
- 用户点击"确认推荐" → 更新实际预算

**费用计算**：
```javascript
总费用 = Σ(每家餐厅人均消费 × 出行人数)
```

---

#### AccommodationSelector（住宿选择器）

**预览逻辑**：
```javascript
previewAccommodationCost = selectedOption?.total_cost || currentAccommodationCost
```

**更新时机**：
- 用户点击酒店卡片 → 预览费用变化
- 用户点击"确认选择" → 更新实际预算

**费用计算**：
```javascript
总费用 = price_per_night × nights
```

---

## 📊 数据流

### 1. 初始化
```
用户输入预算 
  → 后端返回requirements.budget 
  → Store初始化budgetTracking.total
```

### 2. 选择过程
```
用户选择选项 
  → 组件计算previewCost 
  → 更新BudgetProgress显示 
  → 用户看到预览效果
```

### 3. 确认更新
```
用户点击确认 
  → 调用chatStore.updateBudget(category, amount) 
  → 更新budgetTracking[category] 
  → 重新计算budgetTracking.used 
  → 所有组件的BudgetProgress同步更新
```

---

## 🎨 UI设计

### 进度条样式
```scss
背景：紫色渐变 (#667eea → #764ba2)
文字：白色
高亮：金色 (#ffd700)
阴影：紫色半透明
圆角：12px
```

### 布局结构
```
┌─────────────────────────────────────┐
│ 💰 预算使用情况    ¥1500 / ¥3000   │
├─────────────────────────────────────┤
│ ████████████░░░░░░░░░░░░░░░░░░░░░░ │  50%
├─────────────────────────────────────┤
│ 剩余预算：¥1500     使用比例：50.0% │
├─────────────────────────────────────┤
│ 费用明细                             │
│ 🚗 交通  ¥800   ✨ 景点  ¥30        │
│ 🍜 美食  ¥590   🏨 住宿  ¥80        │
└─────────────────────────────────────┘
```

---

## 💡 使用示例

### 场景1：选择交通方式

1. 用户看到三个交通选项：
   - 高铁：¥1106
   - 飞机：¥1700
   - 自驾：¥1000

2. 用户点击"飞机"卡片：
   - 进度条预览：交通 ¥1700
   - 总使用：¥1700（假设其他都是0）
   - 剩余：¥1300（总预算3000）

3. 用户点击"确认选择"：
   - Store更新：`budgetTracking.transport = 1700`
   - 所有后续选择器都会显示这个交通费用

---

### 场景2：选择景点

1. 系统推荐3天行程：
   - 第1天：西湖（免费）
   - 第2天：灵隐寺（¥30）
   - 第3天：茅家埠（免费）

2. 进度条自动显示：
   - 交通：¥1700（已确认）
   - 景点：¥30（预览）
   - 总使用：¥1730
   - 剩余：¥1270

3. 用户点击"确认安排"：
   - Store更新：`budgetTracking.attractions = 30`

---

### 场景3：选择美食

1. 系统推荐每天2家餐厅，出行2人：
   - 第1天：外婆家（¥80×2）+ 楼外楼（¥150×2）
   - 第2天：知味观（¥60×2）+ 灵隐寺素斋（¥100×2）
   - 第3天：龙井茶室（¥80×2）+ 山外山（¥120×2）

2. 进度条自动显示：
   - 交通：¥1700
   - 景点：¥30
   - 美食：¥1180（预览）
   - 总使用：¥2910
   - 剩余：¥90（⚠️ 黄色警告）

3. 用户看到预算紧张，可能会选择调整

---

### 场景4：选择住宿

1. 用户选择"杭州西子湖四季酒店"：
   - 每晚：¥1200
   - 住2晚：¥2400

2. 进度条预览：
   - 交通：¥1700
   - 景点：¥30
   - 美食：¥1180
   - 住宿：¥2400（预览）
   - 总使用：¥5310
   - 剩余：-¥2310（❌ 红色超支）

3. 用户看到超支，选择更便宜的酒店

---

## 🔧 技术细节

### 1. 响应式更新

所有选择器组件都使用 `computed` 监听 `chatStore.budgetTracking`：

```javascript
const budgetTransport = computed(() => chatStore.budgetTracking.transport)
const budgetAttractions = computed(() => chatStore.budgetTracking.attractions)
// ...

const budgetUsed = computed(() => {
  return budgetTransport.value + 
         budgetAttractions.value + 
         budgetFood.value + 
         budgetAccommodation.value
})
```

当任何一个分类预算更新时，所有组件的进度条都会自动更新。

---

### 2. 预览与确认分离

**预览阶段**：
- 用户选择选项 → `selectedOption.value` 变化
- `previewCost` 计算属性自动更新
- BudgetProgress显示新的预览值
- **不更新Store**

**确认阶段**：
- 用户点击确认 → 调用 `chatStore.updateBudget()`
- Store更新 → 触发所有组件响应式更新
- 预览值变为实际值

---

### 3. 费用计算逻辑

#### 交通费用
```javascript
// 往返总费用
total_cost = cost_per_person × companions_count × 2
```

#### 景点费用
```javascript
// 所有景点门票总和
attractions_cost = Σ(ticket_price)
```

#### 美食费用
```javascript
// 所有餐厅人均消费 × 人数
food_cost = Σ(avg_price × companions_count)
```

#### 住宿费用
```javascript
// 每晚价格 × 天数
accommodation_cost = price_per_night × nights
```

---

## 🎯 用户体验优化

### 1. 视觉反馈
- ✅ 进度条颜色随使用比例变化
- ✅ 剩余预算颜色提示（绿/黄/红）
- ✅ 金色数字高亮重要信息
- ✅ 渐变背景提升视觉层次

### 2. 实时预览
- ✅ 选择即预览，无需确认
- ✅ 快速试错，方便比较
- ✅ 避免超支，提前警告

### 3. 分类明细
- ✅ 清晰展示各项费用
- ✅ 图标辅助识别
- ✅ 金色数字突出显示

---

## 📝 注意事项

### 1. 初始化时机
- 预算在用户确认需求后初始化
- 如果 `budgetTotal = 0`，进度条不显示

### 2. 数据同步
- 所有组件共享同一个Store
- 任何更新都会触发全局响应

### 3. 边界情况
- 超支时显示负数（红色）
- 进度条最大100%（即使超支）
- 未选择时显示当前已记录值

---

## 🚀 测试步骤

### 1. 启动项目
```bash
# 前端
cd frontend
npm run dev

# 后端
cd backend
source venv/bin/activate
python main.py
```

### 2. 测试流程
1. 输入需求，设置预算（如3000元）
2. 确认需求 → 查看进度条初始化
3. 选择交通 → 查看预览效果
4. 确认交通 → 查看实际更新
5. 选择景点 → 查看累计效果
6. 选择美食 → 查看预算紧张警告
7. 选择住宿 → 查看超支提示

### 3. 验证点
- ✅ 进度条显示正确
- ✅ 预览功能工作正常
- ✅ 确认后数据更新
- ✅ 颜色状态正确
- ✅ 分类明细准确

---

## 📊 效果展示

### 预算充足（< 60%）
```
💰 预算使用情况    ¥1500 / ¥3000
████████████░░░░░░░░░░░░░░░░░░░░░░  50%  [绿色]
剩余预算：¥1500 [绿色]     使用比例：50.0%
```

### 预算紧张（60-85%）
```
💰 预算使用情况    ¥2400 / ¥3000
████████████████████░░░░░░░░░░░░░░  80%  [橙色]
剩余预算：¥600 [黄色]      使用比例：80.0%
```

### 预算超支（> 100%）
```
💰 预算使用情况    ¥3500 / ¥3000
██████████████████████████████████  100%  [红色]
剩余预算：-¥500 [红色]     使用比例：116.7%
```

---

**更新时间**: 2025-11-19  
**版本**: v1.0  
**状态**: ✅ 开发完成，待测试

