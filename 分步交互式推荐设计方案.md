# 分步交互式旅游攻略推荐设计方案

## 1. 概述

将当前的一次性攻略生成改为**分步交互式推荐**，每一步都让用户参与选择，提升用户体验和个性化程度。

## 2. 推荐流程设计

### 2.1 流程阶段划分

```
用户需求收集（已完成）
    ↓
【阶段1】交通方案推荐
    → 系统推荐3种交通方式（飞机、高铁、自驾）
    → 用户选择1种
    → 记录选择
    ↓
【阶段2】景点推荐（按天分配）
    → 系统推荐每天的景点（每天2-3个）
    → 用户确认或调整
    → 记录选择
    ↓
【阶段3】美食推荐
    → 系统根据已选景点推荐附近餐厅
    → 用户选择每天的餐厅
    → 记录选择
    ↓
【阶段4】住宿推荐
    → 系统推荐酒店（基于景点区域）
    → 用户选择酒店
    → 记录选择
    ↓
【阶段5】生成最终攻略
    → 整合所有选择
    → 生成完整行程
    → 展示给用户
```

### 2.2 状态机设计

```python
class ItineraryStage(Enum):
    # 需求收集阶段
    COLLECTING_REQUIREMENTS = "collecting_requirements"
    CONFIRMING_REQUIREMENTS = "confirming_requirements"
    
    # 分步推荐阶段
    RECOMMENDING_TRANSPORT = "recommending_transport"
    WAITING_TRANSPORT_SELECTION = "waiting_transport_selection"
    
    RECOMMENDING_ATTRACTIONS = "recommending_attractions"
    WAITING_ATTRACTIONS_SELECTION = "waiting_attractions_selection"
    
    RECOMMENDING_FOOD = "recommending_food"
    WAITING_FOOD_SELECTION = "waiting_food_selection"
    
    RECOMMENDING_ACCOMMODATION = "recommending_accommodation"
    WAITING_ACCOMMODATION_SELECTION = "waiting_accommodation_selection"
    
    # 最终生成阶段
    GENERATING_FINAL_ITINERARY = "generating_final_itinerary"
    COMPLETED = "completed"
```

## 3. 数据结构设计

### 3.1 用户选择记录

```python
class UserSelections(BaseModel):
    """用户在各阶段的选择记录"""
    
    # 交通选择
    transport_choice: Optional[Dict[str, Any]] = None  # 包含去程和返程
    
    # 景点选择（按天）
    attractions_by_day: Optional[Dict[int, List[Dict[str, Any]]]] = None
    # 格式: {1: [景点1, 景点2], 2: [景点3, 景点4], ...}
    
    # 美食选择（按天）
    food_by_day: Optional[Dict[int, List[Dict[str, Any]]]] = None
    # 格式: {1: [餐厅1, 餐厅2], 2: [餐厅3], ...}
    
    # 住宿选择
    accommodation_choice: Optional[Dict[str, Any]] = None
```

### 3.2 推荐数据结构

```python
class TransportRecommendation(BaseModel):
    """交通推荐"""
    options: List[Dict[str, Any]]  # 3个选项（飞机、高铁、自驾）
    prompt: str  # 提示文本

class AttractionsRecommendation(BaseModel):
    """景点推荐（按天）"""
    daily_attractions: Dict[int, List[Dict[str, Any]]]
    prompt: str

class FoodRecommendation(BaseModel):
    """美食推荐（按天）"""
    daily_restaurants: Dict[int, List[Dict[str, Any]]]
    prompt: str

class AccommodationRecommendation(BaseModel):
    """住宿推荐"""
    options: List[Dict[str, Any]]
    prompt: str
```

## 4. API接口设计

### 4.1 后端响应格式

```python
{
    "reply": "系统回复文本",
    "stage": "当前阶段",
    "requirements": {...},  # 用户需求
    "recommendation": {     # 推荐数据（如果有）
        "type": "transport|attractions|food|accommodation",
        "data": {...},
        "options": [...]
    },
    "selections": {...},    # 已选择的数据
    "itinerary": {...}      # 最终行程（仅在completed阶段）
}
```

### 4.2 前端请求格式

```python
# 用户选择交通
{
    "message": "我选择高铁",
    "selection": {
        "type": "transport",
        "choice": {
            "outbound": {...},
            "return": {...}
        }
    }
}

# 用户确认景点
{
    "message": "确认景点安排",
    "selection": {
        "type": "attractions",
        "choice": {
            "1": [景点1, 景点2],
            "2": [景点3, 景点4]
        }
    }
}
```

## 5. 实现步骤

### 5.1 后端修改

#### Step 1: 扩展状态管理（`backend/agent/state.py`）
- 添加 `ItineraryStage` 枚举
- 添加 `UserSelections` 模型
- 在 `ConversationState` 中添加 `current_stage` 和 `selections` 字段

#### Step 2: 修改对话管理（`backend/agent/dialogue.py`）
- 在需求确认后，进入交通推荐阶段
- 添加 `_handle_selection` 方法处理用户选择

#### Step 3: 修改核心逻辑（`backend/agent/core.py`）
- 根据 `current_stage` 决定下一步操作
- 实现各阶段的推荐逻辑：
  - `_recommend_transport()`
  - `_recommend_attractions()`
  - `_recommend_food()`
  - `_recommend_accommodation()`
- 实现选择处理逻辑：
  - `_handle_transport_selection()`
  - `_handle_attractions_selection()`
  - `_handle_food_selection()`
  - `_handle_accommodation_selection()`

#### Step 4: 创建推荐生成器（`backend/planner/interactive_recommender.py`）
- 负责生成各阶段的推荐数据
- 使用LLM进行智能推荐和筛选

### 5.2 前端修改

#### Step 1: 扩展消息类型（`frontend/src/stores/chat.js`）
- 添加 `recommendation` 字段支持
- 添加 `selections` 字段支持

#### Step 2: 创建推荐卡片组件（`frontend/src/components/`）
- `TransportSelector.vue` - 交通选择卡片
- `AttractionsSelector.vue` - 景点选择卡片
- `FoodSelector.vue` - 美食选择卡片
- `AccommodationSelector.vue` - 住宿选择卡片

#### Step 3: 修改聊天界面（`frontend/src/views/ChatView.vue`）
- 根据 `recommendation.type` 渲染对应的选择器组件
- 处理用户选择并发送到后端

## 6. 用户交互示例

### 示例对话流程

```
【系统】您好！我是TravelMate AI...
【用户】我想去杭州玩3天
【系统】好的！为了给您制定合适的行程，我需要了解...
【用户】5000元预算，喜欢美食，从北京出发，和朋友一起，2人
【系统】让我为您总结一下...（确认信息）
【用户】确认

--- 阶段1：交通推荐 ---
【系统】🚗 为您推荐3种交通方式：
         [卡片1] 飞机 - ¥1200 - 2小时 - 快速便捷
         [卡片2] 高铁 - ¥553 - 4.5小时 - 性价比高 ⭐推荐
         [卡片3] 自驾 - ¥800 - 13小时 - 自由灵活
         请选择您的交通方式：
【用户】选择高铁

--- 阶段2：景点推荐 ---
【系统】✨ 根据您的偏好，为您推荐以下景点安排：
         第1天：
         - 西湖（免费）- 杭州必游
         - 雷峰塔（¥80）- 西湖边文化景点
         第2天：
         - 灵隐寺（¥60）- 历史文化
         - 南宋御街（免费）- 美食街区
         第3天：
         - 西溪湿地（¥80）- 自然风光
         您可以调整或确认这个安排：
【用户】确认

--- 阶段3：美食推荐 ---
【系统】🍜 根据您选择的景点，为您推荐附近美食：
         第1天：
         - 午餐：茅家埠（西湖附近）- 杭帮菜 - ¥160
         - 晚餐：楼外楼（西湖边）- 老字号 - ¥300
         第2天：
         - 午餐：灵隐素斋（灵隐寺内）- 素食 - ¥120
         - 晚餐：南宋御街小吃（御街）- 小吃 - ¥100
         请选择或调整：
【用户】确认

--- 阶段4：住宿推荐 ---
【系统】🏨 根据您的景点分布，推荐以下酒店：
         [卡片1] 西湖国宾馆 - ¥1500/晚 - 五星级 - 西湖边
         [卡片2] 杭州凯悦酒店 - ¥900/晚 - 四星级 - 市中心 ⭐推荐
         [卡片3] 如家快捷酒店 - ¥300/晚 - 经济型 - 交通便利
         请选择您的住宿：
【用户】选择凯悦酒店

--- 阶段5：生成最终攻略 ---
【系统】✅ 太好了！正在为您生成完整的旅行攻略...
         （展示完整的行程安排，包含所有细节）
```

## 7. 技术要点

### 7.1 状态持久化
- 每次用户选择后，更新 `ConversationState`
- 确保刷新页面后可以恢复状态（可选）

### 7.2 智能推荐
- 使用LLM根据用户偏好和预算筛选推荐项
- 景点推荐时考虑地理位置，合理分配到每一天
- 美食推荐时考虑景点位置，推荐附近餐厅
- 住宿推荐时考虑景点分布，选择中心位置

### 7.3 用户选择解析
- 支持自然语言选择："我选择高铁"、"第一个"、"飞机"
- 使用LLM解析用户意图
- 支持修改："我想换成飞机"

### 7.4 前端交互优化
- 卡片式选择器，美观易用
- 显示已选择的内容
- 支持返回上一步修改（可选）

## 8. 优势

1. **更高的用户参与度**：用户全程参与决策
2. **更强的个性化**：每一步都根据用户选择调整
3. **更好的用户体验**：分步骤，不会一次性给太多信息
4. **更灵活的调整**：用户可以在每一步进行调整
5. **更清晰的决策过程**：用户了解每个选择的原因

## 9. 开发优先级

1. **P0（核心）**：
   - 状态机设计和实现
   - 交通推荐和选择
   - 景点推荐和选择
   - 最终攻略生成

2. **P1（重要）**：
   - 美食推荐和选择
   - 住宿推荐和选择
   - 前端选择器组件

3. **P2（优化）**：
   - 返回上一步功能
   - 状态持久化
   - 更智能的推荐算法

