# æ™¯ç‚¹ä½ç½®ä¿¡æ¯æ›´æ–°è¯´æ˜

## ğŸ“ æ›´æ–°å†…å®¹

ä¸º`Attraction`æ•°æ®æ¨¡å‹æ·»åŠ äº†ä½ç½®ä¿¡æ¯ï¼ˆç»çº¬åº¦ï¼‰ï¼Œä¸`Restaurant`å’Œ`Hotel`ä¿æŒä¸€è‡´çš„æ•°æ®ç»“æ„ã€‚

## ğŸ”§ ä¿®æ”¹è¯¦æƒ…

### 1. æ•°æ®æ¨¡å‹æ›´æ–°

**æ–‡ä»¶**: `backend/rag/retriever.py`

**ä¿®æ”¹å‰**:
```python
@dataclass
class Attraction:
    id: str
    name: str
    city: str
    province: str
    category: str
    description: str
    address: str
    opening_hours: str
    ticket_price: float
    duration_hours: float
    rating: float
    best_season: str
    tips: str
    tags: List[str] = None
```

**ä¿®æ”¹å**:
```python
@dataclass
class Attraction:
    id: str
    name: str
    city: str
    province: str
    category: str
    description: str
    address: str
    opening_hours: str
    ticket_price: float
    duration_hours: float
    rating: float
    best_season: str
    tips: str
    location: Dict = None  # æ–°å¢ï¼šä½ç½®ä¿¡æ¯ {"lat": çº¬åº¦, "lng": ç»åº¦, "address": "è¯¦ç»†åœ°å€"}
    tags: List[str] = None
    
    def __post_init__(self):
        if self.tags is None:
            self.tags = [self.category]
        
        if self.location is None:
            # è‡ªåŠ¨ç”Ÿæˆé»˜è®¤ä½ç½®ï¼ˆMockæ•°æ®ï¼‰
            self.location = {
                "lat": 30.25,  # é»˜è®¤æ­å·çº¬åº¦
                "lng": 120.15,  # é»˜è®¤æ­å·ç»åº¦
                "address": self.address
            }
```

### 2. Mockæ•°æ®æ›´æ–°

ä¸ºæ‰€æœ‰æ™¯ç‚¹æ·»åŠ äº†çœŸå®çš„ç»çº¬åº¦åæ ‡ï¼š

#### æ­å·æ™¯ç‚¹
| æ™¯ç‚¹ | çº¬åº¦ | ç»åº¦ |
|------|------|------|
| è¥¿æ¹– | 30.2547 | 120.1487 |
| çµéšå¯º | 30.2415 | 120.0985 |
| èŒ…å®¶åŸ  | 30.2358 | 120.1298 |

#### å—äº¬æ™¯ç‚¹
| æ™¯ç‚¹ | çº¬åº¦ | ç»åº¦ |
|------|------|------|
| ä¸­å±±é™µ | 32.0589 | 118.8486 |
| å¤«å­åº™ | 32.0186 | 118.7938 |

#### å¹¿å·æ™¯ç‚¹
| æ™¯ç‚¹ | çº¬åº¦ | ç»åº¦ |
|------|------|------|
| å¹¿å·å¡” | 23.1088 | 113.3191 |
| é™ˆå®¶ç¥  | 23.1258 | 113.2438 |

## ğŸ“Š æ•°æ®ç»“æ„ç»Ÿä¸€

ç°åœ¨ä¸‰ç§POIï¼ˆæ™¯ç‚¹ã€é¤å…ã€é…’åº—ï¼‰éƒ½å…·æœ‰ç»Ÿä¸€çš„ä½ç½®ä¿¡æ¯æ ¼å¼ï¼š

```python
location = {
    "lat": float,      # çº¬åº¦
    "lng": float,      # ç»åº¦
    "address": str     # è¯¦ç»†åœ°å€
}
```

### Restaurant (å·²æœ‰)
```python
location: Dict  # {"lat": 30.25, "lng": 120.13, "address": "..."}
```

### Hotel (å·²æœ‰)
```python
location: Dict  # {"lat": 30.25, "lng": 120.13, "address": "..."}
```

### Attraction (æ–°å¢)
```python
location: Dict  # {"lat": 30.25, "lng": 120.13, "address": "..."}
```

## ğŸ¯ åº”ç”¨åœºæ™¯

æœ‰äº†ç»Ÿä¸€çš„ä½ç½®ä¿¡æ¯ï¼Œå¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. åœ°ç†ä½ç½®è®¡ç®—
```python
def calculate_distance(loc1, loc2):
    """è®¡ç®—ä¸¤ä¸ªPOIä¹‹é—´çš„è·ç¦»"""
    from math import radians, sin, cos, sqrt, atan2
    
    lat1, lng1 = radians(loc1['lat']), radians(loc1['lng'])
    lat2, lng2 = radians(loc2['lat']), radians(loc2['lng'])
    
    dlat = lat2 - lat1
    dlng = lng2 - lng1
    
    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlng/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    
    # åœ°çƒåŠå¾„ï¼ˆåƒç±³ï¼‰
    R = 6371
    distance = R * c
    
    return distance
```

### 2. æ™¯ç‚¹èšç±»ï¼ˆæŒ‰åœ°ç†ä½ç½®åˆ†ç»„ï¼‰
```python
def cluster_attractions_by_location(attractions, max_distance_km=5):
    """å°†æ™¯ç‚¹æŒ‰åœ°ç†ä½ç½®èšç±»ï¼ŒåŒä¸€åŒºåŸŸçš„æ™¯ç‚¹åˆ†ä¸ºä¸€ç»„"""
    clusters = []
    # å®ç°èšç±»ç®—æ³•...
    return clusters
```

### 3. æ™ºèƒ½è·¯çº¿è§„åˆ’
```python
def optimize_daily_route(attractions):
    """ä¼˜åŒ–æ¯æ—¥æ¸¸è§ˆè·¯çº¿ï¼Œå‡å°‘ç§»åŠ¨è·ç¦»"""
    # ä½¿ç”¨TSPï¼ˆæ—…è¡Œå•†é—®é¢˜ï¼‰ç®—æ³•ä¼˜åŒ–è·¯çº¿
    optimized_route = []
    # å®ç°è·¯çº¿ä¼˜åŒ–...
    return optimized_route
```

### 4. é™„è¿‘POIæ¨è
```python
def find_nearby_restaurants(attraction, restaurants, max_distance_km=2):
    """æ‰¾åˆ°æ™¯ç‚¹é™„è¿‘çš„é¤å…"""
    nearby = []
    for restaurant in restaurants:
        distance = calculate_distance(
            attraction.location, 
            restaurant.location
        )
        if distance <= max_distance_km:
            nearby.append({
                'restaurant': restaurant,
                'distance': distance
            })
    return sorted(nearby, key=lambda x: x['distance'])
```

### 5. åœ°å›¾å¯è§†åŒ–
```python
def generate_map_data(itinerary):
    """ç”Ÿæˆåœ°å›¾å¯è§†åŒ–æ•°æ®"""
    map_data = {
        'attractions': [],
        'restaurants': [],
        'hotels': [],
        'routes': []
    }
    
    for day_plan in itinerary['daily_plans']:
        for item in day_plan['schedule']:
            if 'location' in item:
                map_data['attractions'].append({
                    'name': item['name'],
                    'lat': item['location']['lat'],
                    'lng': item['location']['lng'],
                    'type': item['type']
                })
    
    return map_data
```

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•ä»£ç 
```python
from rag.retriever import get_retriever

retriever = get_retriever()
attractions = retriever.retrieve_attractions('æ­å·', [], top_k=3)

for a in attractions:
    print(f'{a.name}: lat={a.location["lat"]}, lng={a.location["lng"]}')
```

### æµ‹è¯•ç»“æœ
```
è¥¿æ¹–: lat=30.2547, lng=120.1487
çµéšå¯º: lat=30.2415, lng=120.0985
èŒ…å®¶åŸ : lat=30.2358, lng=120.1298
```

âœ… **æµ‹è¯•é€šè¿‡ï¼æ‰€æœ‰æ™¯ç‚¹éƒ½å…·æœ‰æ­£ç¡®çš„ä½ç½®ä¿¡æ¯ã€‚**

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. é›†æˆçœŸå®åœ°å›¾API
å½“å‰ä½¿ç”¨çš„æ˜¯æ‰‹åŠ¨è¾“å…¥çš„ç»çº¬åº¦ï¼Œå»ºè®®é›†æˆï¼š
- **é«˜å¾·åœ°å›¾API** - åœ°ç†ç¼–ç æœåŠ¡
- **ç™¾åº¦åœ°å›¾API** - POIæœç´¢
- **Google Maps API** - å…¨çƒè¦†ç›–

```python
def geocode_address(address):
    """å°†åœ°å€è½¬æ¢ä¸ºç»çº¬åº¦"""
    # è°ƒç”¨åœ°å›¾API
    response = requests.get(
        'https://restapi.amap.com/v3/geocode/geo',
        params={
            'address': address,
            'key': AMAP_API_KEY
        }
    )
    data = response.json()
    location = data['geocodes'][0]['location'].split(',')
    return {
        'lat': float(location[1]),
        'lng': float(location[0]),
        'address': address
    }
```

### 2. å®ç°è·¯çº¿ä¼˜åŒ–ç®—æ³•
åŸºäºä½ç½®ä¿¡æ¯å®ç°æ™ºèƒ½è·¯çº¿è§„åˆ’ï¼š
- TSPç®—æ³•ï¼ˆæ—…è¡Œå•†é—®é¢˜ï¼‰
- é—ä¼ ç®—æ³•
- è´ªå¿ƒç®—æ³•

### 3. æ·»åŠ äº¤é€šæ—¶é—´ä¼°ç®—
```python
def estimate_travel_time(from_location, to_location, mode='driving'):
    """ä¼°ç®—ä¸¤ç‚¹ä¹‹é—´çš„äº¤é€šæ—¶é—´"""
    # è°ƒç”¨åœ°å›¾APIè·å–è·¯çº¿è§„åˆ’
    # è¿”å›é¢„è®¡æ—¶é—´å’Œè·ç¦»
    pass
```

### 4. å®ç°åœ°å›¾å¯è§†åŒ–
åœ¨å‰ç«¯å±•ç¤ºï¼š
- æ™¯ç‚¹ä½ç½®æ ‡è®°
- é¤å…ä½ç½®æ ‡è®°
- é…’åº—ä½ç½®æ ‡è®°
- æ¯æ—¥æ¸¸è§ˆè·¯çº¿
- è·ç¦»å’Œæ—¶é—´æ ‡æ³¨

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ•°æ®æ¨¡å‹**: `backend/rag/retriever.py`
- **ç¾é£ŸæœåŠ¡**: `backend/tools/food.py`
- **ä½å®¿æœåŠ¡**: `backend/tools/accommodation.py`
- **äº¤é€šæœåŠ¡**: `backend/tools/transport.py`

---

**æ›´æ–°æ—¶é—´**: 2025-11-18  
**ç‰ˆæœ¬**: v2.1  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

