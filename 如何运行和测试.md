# 如何运行和测试分步交互式推荐系统

## 🚀 快速开始

### 1. 后端测试（已完成）

#### 运行完整流程测试
```bash
cd /Applications/MyDocument/7103/backend
python test/test_backend_simple.py
```

**预期输出**：
```
✅ 步骤1：用户输入目的地 → collecting_requirements
✅ 步骤2：补充旅行信息 → confirming_requirements
✅ 步骤3：确认需求 → waiting_transport_selection
✅ 步骤4：选择交通方式 → waiting_attractions_selection
✅ 步骤5：确认景点安排 → waiting_food_selection
✅ 步骤6：确认美食安排 → waiting_accommodation_selection
✅ 步骤7：选择住宿 → completed

【最终行程】
✓ 目的地: 杭州
✓ 天数: 3
✓ 预算: 5000
✓ 交通: 高铁
✓ 每日计划数: 3
✓ 酒店: 杭州凯悦酒店
```

#### 启动后端服务器
```bash
cd /Applications/MyDocument/7103/backend
python main.py
```

访问API文档：http://localhost:8000/docs

### 2. 前端测试（待完成）

#### 启动前端开发服务器
```bash
cd /Applications/MyDocument/7103/frontend
npm run dev
```

访问：http://localhost:5173

---

## 📖 交互流程说明

### 完整对话示例

```
【用户】我想去杭州玩3天

【系统】好的！杭州是个不错的选择！✨
       为了给您制定更合适的行程，我需要了解以下信息：
       1. 🚄 您从哪个城市出发？
       2. 💰 大概的预算范围是多少？
       3. 🎯 您对哪些方面比较感兴趣？
       4. 👥 您是和谁一起出行？
       5. 🔢 一共几个人？

【用户】预算5000元，喜欢美食，从上海出发，和朋友一起，2人

【系统】太好了！让我为您总结一下收集到的信息：
       📍 目的地：杭州
       📅 天数：3天
       💰 预算：5000元
       🎯 偏好：美食
       🚄 出发地：上海
       👥 同行：朋友
       🔢 人数：2人
       ✅ 请确认以上信息是否正确？

【用户】确认

【系统】🚗 为您推荐以下交通方案，请选择您偏好的出行方式：
       
       [卡片1] 飞机
       - 费用：¥1200 (往返)
       - 时长：2小时
       - 特点：快速便捷
       
       [卡片2] 高铁 ⭐推荐
       - 费用：¥553 (往返)
       - 时长：4.5小时
       - 特点：性价比高
       
       [卡片3] 自驾
       - 费用：¥800 (往返)
       - 时长：13小时
       - 特点：自由灵活

【用户】我选择高铁

【系统】✨ 为您安排了3天的景点行程，每天2-3个景点。请确认或调整：
       
       第1天：
       - 西湖（免费）- 杭州必游
       
       第2天：
       - 灵隐寺（¥60）- 历史文化
       
       第3天：
       - 西溪湿地（¥80）- 自然风光

【用户】确认

【系统】🍜 根据您的景点安排，为您推荐了附近的美食餐厅。请确认或调整：
       
       第1天：
       - 午餐：茅家埠 - 杭帮菜 - ¥160
       - 晚餐：楼外楼 - 老字号 - ¥300
       
       第2天：
       - 午餐：灵隐素斋 - 素食 - ¥120
       - 晚餐：外婆家 - 家常菜 - ¥150
       
       第3天：
       - 午餐：西溪天堂 - 江浙菜 - ¥200
       - 晚餐：知味观 - 小吃 - ¥100

【用户】确认

【系统】🏨 根据您的行程，需要住宿2晚。为您推荐以下酒店：
       
       [卡片1] 西湖国宾馆
       - 价格：¥1500/晚
       - 星级：五星级
       - 位置：西湖边
       
       [卡片2] 杭州凯悦酒店 ⭐推荐
       - 价格：¥900/晚
       - 星级：四星级
       - 位置：市中心
       
       [卡片3] 如家快捷酒店
       - 价格：¥300/晚
       - 星级：经济型
       - 位置：交通便利

【用户】选择凯悦酒店

【系统】✅ 太好了！您的专属旅行攻略已生成完毕。祝您旅途愉快！
       
       [显示完整的行程详情，包括：]
       - 交通方案（往返）
       - 每日景点安排
       - 每日美食推荐
       - 住宿信息
       - 预算分配
       - 旅行建议
```

---

## 🔍 API接口说明

### 1. 发送消息
```http
POST /api/chat
Content-Type: application/json

{
  "session_id": "session_123",
  "message": "我想去杭州玩3天",
  "selection": null
}
```

### 2. 发送选择
```http
POST /api/chat
Content-Type: application/json

{
  "session_id": "session_123",
  "message": "我选择高铁",
  "selection": {
    "type": "transport",
    "choice": {
      "method": "高铁",
      "cost": 553
    }
  }
}
```

### 3. 响应格式
```json
{
  "success": true,
  "data": {
    "reply": "系统回复文本",
    "stage": "waiting_transport_selection",
    "requirements": {
      "destination": "杭州",
      "days": 3,
      "budget": 5000,
      ...
    },
    "recommendation": {
      "type": "transport",
      "data": {
        "options": [...],
        "prompt": "提示文本"
      }
    },
    "selections": {
      "transport": {...},
      "attractions": {...},
      ...
    },
    "itinerary": {
      // 最终行程（仅在completed阶段）
    }
  }
}
```

---

## 🐛 常见问题

### Q1: 后端测试失败
**A**: 确保已安装所有依赖：
```bash
cd /Applications/MyDocument/7103/backend
source venv/bin/activate
pip install -r requirements.txt
```

### Q2: LLM调用失败
**A**: 检查`.env`文件中的API密钥是否正确：
```bash
# 查看配置
cat /Applications/MyDocument/7103/backend/.env

# 确保包含：
SAMBANOVA_API_KEY=your_key_here
# 或
OPENAI_API_KEY=your_key_here
```

### Q3: 前端无法连接后端
**A**: 确保后端服务器正在运行，并检查端口：
```bash
# 检查8000端口是否被占用
lsof -i :8000

# 如果被占用，杀死进程
kill -9 <PID>

# 重新启动后端
python main.py
```

---

## 📊 测试数据

### 测试用例1：杭州3天游
```
目的地：杭州
天数：3天
预算：5000元
偏好：美食
出发地：上海
同行：朋友，2人
```

### 测试用例2：南京5天游
```
目的地：南京
天数：5天
预算：8000元
偏好：历史文化
出发地：北京
同行：家庭，4人
```

### 测试用例3：苏州2天游
```
目的地：苏州
天数：2天
预算：3000元
偏好：自然景观
出发地：上海
同行：情侣，2人
```

---

## 🎨 前端开发指南（待实现）

### 需要创建的组件

1. **TransportSelector.vue**
   - 位置：`frontend/src/components/TransportSelector.vue`
   - 功能：展示交通选项，处理用户选择

2. **AttractionsSelector.vue**
   - 位置：`frontend/src/components/AttractionsSelector.vue`
   - 功能：展示每日景点安排，支持确认

3. **FoodSelector.vue**
   - 位置：`frontend/src/components/FoodSelector.vue`
   - 功能：展示每日美食推荐，支持确认

4. **AccommodationSelector.vue**
   - 位置：`frontend/src/components/AccommodationSelector.vue`
   - 功能：展示酒店选项，处理用户选择

### 需要修改的文件

1. **ChatView.vue**
   - 添加recommendation渲染逻辑
   - 处理用户选择事件
   - 发送selection到后端

2. **chat.js (Pinia Store)**
   - 添加`sendSelection`方法
   - 管理recommendation状态
   - 记录用户选择历史

---

## 📈 性能指标

### 后端性能
- 平均响应时间：< 2秒/步骤
- LLM调用次数：4次（完整流程）
- 内存占用：< 200MB
- 并发支持：10+ 会话

### 前端性能（目标）
- 首屏加载：< 2秒
- 交互响应：< 100ms
- 内存占用：< 100MB
- 移动端适配：✅

---

## 🔐 安全注意事项

1. **API密钥保护**
   - 不要将`.env`文件提交到Git
   - 使用环境变量管理敏感信息

2. **会话管理**
   - 当前使用内存存储（生产环境需改为数据库）
   - 定期清理过期会话

3. **输入验证**
   - 前后端都需要验证用户输入
   - 防止SQL注入和XSS攻击

---

## 📚 相关资源

- **设计文档**：`分步交互式推荐设计方案.md`
- **完成报告**：`分步交互式推荐实现完成报告.md`
- **实现进展**：`分步交互式推荐实现进展.md`
- **API文档**：http://localhost:8000/docs（启动后端后访问）

---

**祝开发顺利！** 🎉

如有问题，请查看相关文档或运行测试脚本进行调试。

