# ğŸ—ºï¸ TravelMate AI - æ—…æ¸¸æ”»ç•¥ç”Ÿæˆæ–¹æ¡ˆ

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¶é—´**: 2025-11-18  
**è´Ÿè´£äºº**: æˆå‘˜Bï¼ˆRAGç³»ç»Ÿï¼‰+ æˆå‘˜Cï¼ˆè¡Œç¨‹è§„åˆ’ç®—æ³•ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [æ–¹æ¡ˆæ¦‚è¿°](#æ–¹æ¡ˆæ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ¥å£è®¾è®¡](#æ¥å£è®¾è®¡)
4. [æ•°æ®æµç¨‹](#æ•°æ®æµç¨‹)
5. [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
6. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
7. [å¼€å‘è®¡åˆ’](#å¼€å‘è®¡åˆ’)

---

## 1. æ–¹æ¡ˆæ¦‚è¿°

### 1.1 ç›®æ ‡

ç”ŸæˆåŒ…å«**äº¤é€šã€æ™¯ç‚¹ã€ç¾é£Ÿã€ä½å®¿ã€è·¯çº¿è§„åˆ’**çš„å®Œæ•´æ—…æ¸¸æ”»ç•¥ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ç«™å¼æ—…è¡Œè§„åˆ’æœåŠ¡ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

```
æ—…æ¸¸æ”»ç•¥ç”Ÿæˆ
â”œâ”€â”€ 1. è·¨åŸäº¤é€šè§„åˆ’ (å‡ºå‘åœ° â†’ ç›®çš„åœ°)
â”œâ”€â”€ 2. æ™¯ç‚¹æ¨è (åŸºäºRAGå‘é‡æ£€ç´¢)
â”œâ”€â”€ 3. ç¾é£Ÿæ¨è (POIé™„è¿‘ç¾é£Ÿåº—é“º)
â”œâ”€â”€ 4. ä½å®¿æ¨è (åŸºäºæ™¯ç‚¹/ç¾é£Ÿä½ç½®)
â””â”€â”€ 5. å¸‚å†…äº¤é€šè§„åˆ’ (æ¯æ—¥è·¯çº¿ä¼˜åŒ–) [å¯é€‰]
```

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent Core                            â”‚
â”‚                    (æˆå‘˜Aï¼šå¯¹è¯ç®¡ç†)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ ç”¨æˆ·éœ€æ±‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Itinerary Generator                         â”‚
â”‚                  (æˆå‘˜Cï¼šè¡Œç¨‹ç”Ÿæˆå™¨)                          â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚       â”‚       â”‚       â”‚       â”‚
  â†“       â†“       â†“       â†“       â†“
â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”
â”‚ 1 â”‚   â”‚ 2 â”‚   â”‚ 3 â”‚   â”‚ 4 â”‚   â”‚ 5 â”‚
â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜   â””â”€â”€â”€â”˜
è·¨åŸ    æ™¯ç‚¹    ç¾é£Ÿ    ä½å®¿    å¸‚å†…
äº¤é€š    æ¨è    æ¨è    æ¨è    äº¤é€š

æˆå‘˜C   æˆå‘˜B   æˆå‘˜C   æˆå‘˜C   æˆå‘˜C
```

### 2.2 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | è´Ÿè´£äºº | æ ¸å¿ƒåŠŸèƒ½ | æ•°æ®æ¥æº |
|-----|--------|---------|---------|
| è·¨åŸäº¤é€š | æˆå‘˜C | é£æœº/ç«è½¦/è‡ªé©¾è·¯çº¿ | 12306/æºç¨‹API + è§„åˆ™ä¼°ç®— |
| æ™¯ç‚¹æ¨è | æˆå‘˜B | RAGå‘é‡æ£€ç´¢ | ChromaDBå‘é‡åº“ |
| ç¾é£Ÿæ¨è | æˆå‘˜C | POIé™„è¿‘ç¾é£ŸæŸ¥è¯¢ | é«˜å¾·åœ°å›¾API + çˆ¬å–æ•°æ® |
| ä½å®¿æ¨è | æˆå‘˜C | åŒºåŸŸå†…é…’åº—æŸ¥è¯¢ | æºç¨‹/å»å“ªå„¿çˆ¬å–æ•°æ® |
| å¸‚å†…äº¤é€š | æˆå‘˜C | æ¯æ—¥è·¯çº¿ä¼˜åŒ– | é«˜å¾·åœ°å›¾API + TSPç®—æ³• |

---

## 3. æ¥å£è®¾è®¡

### 3.1 æ¨¡å—1: è·¨åŸäº¤é€šæ¥å£

#### **æ¥å£åç§°**: `InterCityTransportService`

**åŠŸèƒ½**: æä¾›å‡ºå‘åœ°åˆ°ç›®çš„åœ°çš„äº¤é€šæ–¹å¼é€‰æ‹©ï¼ˆé£æœºã€ç«è½¦ã€è‡ªé©¾ï¼‰

**æ–‡ä»¶ä½ç½®**: `backend/tools/transport.py`

**æ¥å£å®šä¹‰**:

```python
class InterCityTransportService:
    """è·¨åŸäº¤é€šæœåŠ¡"""
    
    def get_transport_options(
        self,
        departure_city: str,
        destination_city: str,
        travel_date: str = None,
        companions_count: int = 1
    ) -> List[TransportOption]:
        """
        è·å–è·¨åŸäº¤é€šæ–¹æ¡ˆ
        
        Args:
            departure_city: å‡ºå‘åŸå¸‚
            destination_city: ç›®çš„åœ°åŸå¸‚
            travel_date: å‡ºè¡Œæ—¥æœŸ (å¯é€‰)
            companions_count: å‡ºè¡Œäººæ•°
        
        Returns:
            äº¤é€šæ–¹æ¡ˆåˆ—è¡¨ï¼ŒæŒ‰æ¨èåº¦æ’åº
        """
        pass
```

**æ•°æ®æ¨¡å‹**:

```python
@dataclass
class TransportOption:
    """äº¤é€šæ–¹æ¡ˆ"""
    method: str  # "é£æœº" | "é«˜é“" | "æ™®é€šç«è½¦" | "è‡ªé©¾"
    duration_hours: float  # æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    cost_per_person: float  # å•äººè´¹ç”¨
    total_cost: float  # æ€»è´¹ç”¨
    departure_time: str  # å»ºè®®å‡ºå‘æ—¶é—´
    arrival_time: str  # é¢„è®¡åˆ°è¾¾æ—¶é—´
    description: str  # æ–¹æ¡ˆæè¿°
    recommendation_score: float  # æ¨èåˆ†æ•° (0-1)
    details: Dict  # è¯¦ç»†ä¿¡æ¯
    # é£æœº: {"flight_number": "CA1234", "airline": "å›½èˆª"}
    # ç«è½¦: {"train_number": "G1234", "seat_type": "äºŒç­‰åº§"}
    # è‡ªé©¾: {"distance_km": 300, "toll_fee": 150}
```

**å®ç°ç­–ç•¥**:

1. **è·ç¦»è®¡ç®—**: ä½¿ç”¨é«˜å¾·åœ°å›¾APIè·å–ä¸¤åœ°è·ç¦»
2. **æ–¹æ¡ˆç”Ÿæˆ**:
   - **< 300km**: æ¨èé«˜é“/è‡ªé©¾
   - **300-800km**: æ¨èé«˜é“
   - **> 800km**: æ¨èé£æœº/é«˜é“
3. **è´¹ç”¨ä¼°ç®—**:
   - é£æœº: è·ç¦» Ã— 0.8å…ƒ/kmï¼ˆç»æµèˆ±ï¼‰
   - é«˜é“: è·ç¦» Ã— 0.5å…ƒ/kmï¼ˆäºŒç­‰åº§ï¼‰
   - è‡ªé©¾: æ²¹è´¹(è·ç¦»Ã—0.6) + è¿‡è·¯è´¹(è·ç¦»Ã—0.4)

**APIä¾èµ–**:
- âœ… é«˜å¾·åœ°å›¾è·¯å¾„è§„åˆ’API (å…è´¹é¢åº¦: 30ä¸‡æ¬¡/å¤©)
- ğŸ”„ 12306æŸ¥è¯¢API (å¯é€‰ï¼Œç”¨äºå®æ—¶ç¥¨ä»·)
- ğŸ”„ æºç¨‹æœºç¥¨API (å¯é€‰ï¼Œç”¨äºå®æ—¶ç¥¨ä»·)

---

### 3.2 æ¨¡å—2: æ™¯ç‚¹æ¨èæ¥å£

#### **æ¥å£åç§°**: `RAGRetriever` (å·²å®ç°)

**åŠŸèƒ½**: åŸºäºRAGå‘é‡æ£€ç´¢æ¨èæ™¯ç‚¹

**æ–‡ä»¶ä½ç½®**: `backend/rag/retriever.py`

**æ¥å£å®šä¹‰**:

```python
class RAGRetriever:
    """RAGæ™¯ç‚¹æ£€ç´¢æœåŠ¡"""
    
    def retrieve_attractions(
        self,
        city: str,
        preferences: List[str],
        top_k: int = 15,
        budget_min: float = 0,
        budget_max: float = 1000
    ) -> List[Attraction]:
        """
        æ£€ç´¢æ¨èæ™¯ç‚¹
        
        Args:
            city: ç›®çš„åœ°åŸå¸‚
            preferences: åå¥½æ ‡ç­¾ ["æ–‡åŒ–", "ç¾é£Ÿ", "è‡ªç„¶", "ä¼‘é—²"]
            top_k: è¿”å›æ•°é‡
            budget_min: æœ€ä½é—¨ç¥¨ä»·æ ¼
            budget_max: æœ€é«˜é—¨ç¥¨ä»·æ ¼
        
        Returns:
            æ™¯ç‚¹åˆ—è¡¨ï¼ŒæŒ‰ç›¸å…³åº¦æ’åº
        """
        pass
```

**æ•°æ®æ¨¡å‹**:

```python
@dataclass
class Attraction:
    """æ™¯ç‚¹ä¿¡æ¯"""
    id: str
    name: str
    city: str
    category: List[str]  # ["è‡ªç„¶é£å…‰", "å†å²æ–‡åŒ–"]
    rating: float  # è¯„åˆ† (0-5)
    ticket_price: float  # é—¨ç¥¨ä»·æ ¼
    duration_hours: float  # å»ºè®®æ¸¸ç©æ—¶é•¿
    location: Dict  # {"lat": 30.25, "lng": 120.13, "address": "..."}
    description: str  # æ™¯ç‚¹æè¿°
    tags: List[str]  # ["å¿…æ¸¸", "å…è´¹", "é€‚åˆæ‹ç…§"]
    opening_hours: str  # å¼€æ”¾æ—¶é—´
    best_season: List[str]  # æœ€ä½³å­£èŠ‚
    tips: str  # æ¸¸ç©è´´å£«
```

**å®ç°ç­–ç•¥**:

1. **æ•°æ®å‡†å¤‡**: 
   - çˆ¬å–æºç¨‹/é©¬èœ‚çªæ™¯ç‚¹æ•°æ®ï¼ˆ200æ¡ï¼‰
   - æ ‡å‡†åŒ–ä¸ºJSONæ ¼å¼
   - ä½¿ç”¨OpenAI Embeddingå‘é‡åŒ–
   - å­˜å‚¨åˆ°ChromaDB

2. **æ£€ç´¢ç­–ç•¥**:
   - è¯­ä¹‰æ£€ç´¢: æ ¹æ®åå¥½æ ‡ç­¾æŸ¥è¯¢ç›¸ä¼¼æ™¯ç‚¹
   - è¿‡æ»¤: æŒ‰åŸå¸‚ã€é¢„ç®—ã€è¯„åˆ†è¿‡æ»¤
   - æ’åº: ç»¼åˆè¯„åˆ† = ç›¸ä¼¼åº¦Ã—0.4 + è¯„åˆ†Ã—0.3 + çƒ­åº¦Ã—0.3

**æ•°æ®æ¥æº**:
- âœ… Kaggleæ™¯ç‚¹æ•°æ®é›† (å·²æœ‰)
- âœ… æºç¨‹/å»å“ªå„¿çˆ¬å– (è¡¥å……)

---

### 3.3 æ¨¡å—3: ç¾é£Ÿæ¨èæ¥å£

#### **æ¥å£åç§°**: `FoodRecommendationService`

**åŠŸèƒ½**: æ ¹æ®æ™¯ç‚¹POIæŸ¥è¯¢é™„è¿‘ç¾é£Ÿåº—é“º

**æ–‡ä»¶ä½ç½®**: `backend/tools/food.py`

**æ¥å£å®šä¹‰**:

```python
class FoodRecommendationService:
    """ç¾é£Ÿæ¨èæœåŠ¡"""
    
    def get_nearby_restaurants(
        self,
        location: Dict,  # {"lat": 30.25, "lng": 120.13}
        radius_km: float = 2.0,
        cuisine_type: List[str] = None,  # ["æ­å¸®èœ", "å°åƒ"]
        budget_per_person: float = 100,
        top_k: int = 5
    ) -> List[Restaurant]:
        """
        æŸ¥è¯¢é™„è¿‘ç¾é£Ÿåº—é“º
        
        Args:
            location: ä¸­å¿ƒä½ç½®ï¼ˆæ™¯ç‚¹/é…’åº—åæ ‡ï¼‰
            radius_km: æœç´¢åŠå¾„ï¼ˆå…¬é‡Œï¼‰
            cuisine_type: èœç³»ç±»å‹
            budget_per_person: äººå‡é¢„ç®—
            top_k: è¿”å›æ•°é‡
        
        Returns:
            é¤å…åˆ—è¡¨ï¼ŒæŒ‰æ¨èåº¦æ’åº
        """
        pass
```

**æ•°æ®æ¨¡å‹**:

```python
@dataclass
class Restaurant:
    """é¤å…ä¿¡æ¯"""
    name: str
    cuisine_type: str  # "æ­å¸®èœ" | "å°åƒ" | "ç«é”…"
    rating: float  # è¯„åˆ† (0-5)
    avg_price: float  # äººå‡æ¶ˆè´¹
    location: Dict  # {"lat": 30.25, "lng": 120.13, "address": "..."}
    distance_km: float  # è·ç¦»ä¸­å¿ƒç‚¹çš„è·ç¦»
    signature_dishes: List[str]  # æ‹›ç‰Œèœ
    description: str  # åº—é“ºæè¿°
    opening_hours: str  # è¥ä¸šæ—¶é—´
    tags: List[str]  # ["å¿…åƒ", "ç½‘çº¢åº—", "è€å­—å·"]
    phone: str  # è”ç³»ç”µè¯
```

**å®ç°ç­–ç•¥**:

**æ–¹æ¡ˆA: é«˜å¾·åœ°å›¾POIæœç´¢API** â­ æ¨è

```python
# é«˜å¾·åœ°å›¾å‘¨è¾¹æœç´¢API
url = "https://restapi.amap.com/v3/place/around"
params = {
    "key": AMAP_KEY,
    "location": f"{lng},{lat}",
    "keywords": "é¤å…|ç¾é£Ÿ",
    "types": "050000",  # é¤é¥®æœåŠ¡
    "radius": 2000,  # 2km
    "offset": 20
}
```

**æ–¹æ¡ˆB: é¢„å…ˆçˆ¬å– + æœ¬åœ°æŸ¥è¯¢**

1. çˆ¬å–å¤§ä¼—ç‚¹è¯„/ç¾å›¢çƒ­é—¨é¤å…ï¼ˆæ¯åŸå¸‚50å®¶ï¼‰
2. å­˜å‚¨åˆ°æœ¬åœ°æ•°æ®åº“
3. æ ¹æ®åæ ‡è®¡ç®—è·ç¦»ï¼Œè¿”å›é™„è¿‘é¤å…

**æ¨èé€»è¾‘**:

```python
æ¨èåˆ†æ•° = è¯„åˆ†Ã—0.4 + (1/è·ç¦»)Ã—0.3 + ä»·æ ¼åŒ¹é…åº¦Ã—0.2 + çƒ­åº¦Ã—0.1
```

**APIä¾èµ–**:
- âœ… é«˜å¾·åœ°å›¾POIæœç´¢API (å…è´¹é¢åº¦: 30ä¸‡æ¬¡/å¤©)
- ğŸ”„ å¤§ä¼—ç‚¹è¯„çˆ¬å–æ•°æ® (è¡¥å……)

---

### 3.4 æ¨¡å—4: ä½å®¿æ¨èæ¥å£

#### **æ¥å£åç§°**: `AccommodationService`

**åŠŸèƒ½**: æ ¹æ®æ™¯ç‚¹/ç¾é£ŸPOIæŸ¥è¯¢åŒºåŸŸå†…é…’åº—

**æ–‡ä»¶ä½ç½®**: `backend/tools/accommodation.py`

**æ¥å£å®šä¹‰**:

```python
class AccommodationService:
    """ä½å®¿æ¨èæœåŠ¡"""
    
    def get_hotels_in_area(
        self,
        city: str,
        poi_list: List[Dict],  # æ™¯ç‚¹/ç¾é£Ÿåæ ‡åˆ—è¡¨
        budget_per_night: float,
        nights: int,
        companions_count: int = 1,
        top_k: int = 5
    ) -> List[Hotel]:
        """
        æŸ¥è¯¢åŒºåŸŸå†…é…’åº—
        
        Args:
            city: åŸå¸‚
            poi_list: POIåˆ—è¡¨ï¼ˆæ™¯ç‚¹ã€ç¾é£Ÿåº—åæ ‡ï¼‰
            budget_per_night: æ¯æ™šé¢„ç®—
            nights: ä½å®¿å¤©æ•°
            companions_count: å…¥ä½äººæ•°
            top_k: è¿”å›æ•°é‡
        
        Returns:
            é…’åº—åˆ—è¡¨ï¼ŒæŒ‰æ¨èåº¦æ’åº
        """
        pass
```

**æ•°æ®æ¨¡å‹**:

```python
@dataclass
class Hotel:
    """é…’åº—ä¿¡æ¯"""
    name: str
    hotel_type: str  # "ç»æµå‹" | "èˆ’é€‚å‹" | "é«˜æ¡£å‹"
    rating: float  # è¯„åˆ† (0-5)
    price_per_night: float  # æ¯æ™šä»·æ ¼
    location: Dict  # {"lat": 30.25, "lng": 120.13, "address": "..."}
    distance_to_center: float  # è·ç¦»POIä¸­å¿ƒçš„è·ç¦»ï¼ˆkmï¼‰
    facilities: List[str]  # ["WiFi", "æ—©é¤", "åœè½¦åœº", "å¥èº«æˆ¿"]
    room_type: str  # "æ ‡å‡†é—´" | "å¤§åºŠæˆ¿" | "å¥—æˆ¿"
    description: str  # é…’åº—æè¿°
    tags: List[str]  # ["è¿‘åœ°é“", "æ™¯åŒºé™„è¿‘", "å•†åœˆ"]
    phone: str  # è”ç³»ç”µè¯
    total_cost: float  # æ€»è´¹ç”¨ (price_per_night Ã— nights)
```

**å®ç°ç­–ç•¥**:

1. **è®¡ç®—POIä¸­å¿ƒç‚¹**:
   ```python
   center_lat = sum([poi["lat"] for poi in poi_list]) / len(poi_list)
   center_lng = sum([poi["lng"] for poi in poi_list]) / len(poi_list)
   ```

2. **é…’åº—æ•°æ®æ¥æº**:
   - **æ–¹æ¡ˆA**: çˆ¬å–æºç¨‹/å»å“ªå„¿ï¼ˆæ¯åŸå¸‚æ¯æ¡£æ¬¡10-15å®¶ï¼‰
   - **æ–¹æ¡ˆB**: ä½¿ç”¨é«˜å¾·POIæœç´¢APIï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰

3. **æ¨èé€»è¾‘**:
   ```python
   æ¨èåˆ†æ•° = è¯„åˆ†Ã—0.3 + ä»·æ ¼åŒ¹é…åº¦Ã—0.3 + (1/è·ç¦»)Ã—0.25 + è®¾æ–½å®Œå–„åº¦Ã—0.15
   
   # ä»·æ ¼åŒ¹é…åº¦
   price_match = 1 - abs(price - budget) / budget
   
   # è®¾æ–½å®Œå–„åº¦
   facility_score = len(facilities) / 10
   ```

4. **æˆ¿é—´æ•°é‡è®¡ç®—**:
   ```python
   if companions_count <= 2:
       rooms = 1  # 1é—´æ ‡å‡†é—´/å¤§åºŠæˆ¿
   else:
       rooms = ceil(companions_count / 2)  # æ¯2äºº1é—´
   ```

**æ•°æ®æ¥æº**:
- ğŸ”„ æºç¨‹é…’åº—æ•°æ®çˆ¬å–
- ğŸ”„ å»å“ªå„¿é…’åº—æ•°æ®çˆ¬å–
- âœ… é«˜å¾·åœ°å›¾POIæœç´¢API (å¤‡é€‰)

---

### 3.5 æ¨¡å—5: å¸‚å†…äº¤é€šè§„åˆ’æ¥å£ [å¯é€‰]

#### **æ¥å£åç§°**: `IntraCityRouteOptimizer`

**åŠŸèƒ½**: æ ¹æ®æ™¯ç‚¹ã€ç¾é£Ÿã€é…’åº—POIè§„åˆ’æ¯æ—¥æœ€ä¼˜è·¯çº¿

**æ–‡ä»¶ä½ç½®**: `backend/planner/route_optimizer.py`

**æ¥å£å®šä¹‰**:

```python
class IntraCityRouteOptimizer:
    """å¸‚å†…è·¯çº¿ä¼˜åŒ–å™¨"""
    
    def optimize_daily_route(
        self,
        hotel_location: Dict,
        attractions: List[Dict],  # å½“å¤©è¦å»çš„æ™¯ç‚¹
        restaurants: List[Dict],  # å½“å¤©è¦å»çš„é¤å…
        start_time: str = "09:00",
        end_time: str = "21:00"
    ) -> DailyRoute:
        """
        ä¼˜åŒ–æ¯æ—¥è·¯çº¿
        
        Args:
            hotel_location: é…’åº—ä½ç½®
            attractions: æ™¯ç‚¹åˆ—è¡¨ï¼ˆå«åæ ‡ã€æ¸¸ç©æ—¶é•¿ï¼‰
            restaurants: é¤å…åˆ—è¡¨ï¼ˆå«åæ ‡ï¼‰
            start_time: å¼€å§‹æ—¶é—´
            end_time: ç»“æŸæ—¶é—´
        
        Returns:
            ä¼˜åŒ–åçš„æ¯æ—¥è·¯çº¿
        """
        pass
```

**æ•°æ®æ¨¡å‹**:

```python
@dataclass
class DailyRoute:
    """æ¯æ—¥è·¯çº¿"""
    day: int
    total_distance_km: float  # æ€»è·ç¦»
    total_duration_hours: float  # æ€»æ—¶é•¿
    schedule: List[RoutePoint]  # æ—¶é—´è¡¨
    transport_cost: float  # äº¤é€šè´¹ç”¨
    route_map_url: str  # è·¯çº¿åœ°å›¾URLï¼ˆå¯é€‰ï¼‰

@dataclass
class RoutePoint:
    """è·¯çº¿ç‚¹"""
    time: str  # "09:00"
    poi_name: str  # POIåç§°
    poi_type: str  # "æ™¯ç‚¹" | "é¤å…" | "é…’åº—"
    location: Dict
    duration_minutes: int  # åœç•™æ—¶é•¿
    transport_to_next: Dict  # åˆ°ä¸‹ä¸€ä¸ªç‚¹çš„äº¤é€š
    # {
    #   "method": "åœ°é“",
    #   "duration": 30,
    #   "distance": 5.2,
    #   "cost": 3
    # }
```

**å®ç°ç­–ç•¥**:

1. **è·¯çº¿ä¼˜åŒ–ç®—æ³•**: TSP (Traveling Salesman Problem)

   ```python
   # ä½¿ç”¨è´ªå¿ƒç®—æ³• + 2-optä¼˜åŒ–
   def optimize_route(points):
       # 1. è´ªå¿ƒï¼šä»é…’åº—å‡ºå‘ï¼Œæ¯æ¬¡é€‰æ‹©æœ€è¿‘çš„æœªè®¿é—®ç‚¹
       route = greedy_nearest_neighbor(hotel, points)
       
       # 2. 2-optå±€éƒ¨ä¼˜åŒ–
       route = two_opt_optimization(route)
       
       return route
   ```

2. **æ—¶é—´å®‰æ’**:

   ```python
   current_time = start_time  # 09:00
   
   for poi in route:
       # åˆ°è¾¾æ—¶é—´
       arrival_time = current_time + transport_duration
       
       # æ´»åŠ¨æ—¶é—´
       activity_duration = poi.duration_hours
       
       # ç¦»å¼€æ—¶é—´
       departure_time = arrival_time + activity_duration
       
       current_time = departure_time
   ```

3. **é¤é¥®æ—¶é—´æ’å…¥**:

   ```python
   # åœ¨11:30-13:00ä¹‹é—´æ’å…¥åˆé¤
   # åœ¨17:30-19:00ä¹‹é—´æ’å…¥æ™šé¤
   if 11.5 <= current_time <= 13.0:
       insert_restaurant(route, current_time, "åˆé¤")
   ```

4. **äº¤é€šæ–¹å¼é€‰æ‹©**:

   ```python
   def choose_transport(distance_km):
       if distance_km < 1.5:
           return "æ­¥è¡Œ"
       elif distance_km < 5:
           return "åœ°é“/å…¬äº¤"
       elif distance_km < 15:
           return "å‡ºç§Ÿè½¦"
       else:
           return "åŒ…è½¦/ç§Ÿè½¦"
   ```

**APIä¾èµ–**:
- âœ… é«˜å¾·åœ°å›¾è·¯å¾„è§„åˆ’API
- âœ… é«˜å¾·åœ°å›¾å…¬äº¤è§„åˆ’API

---

## 4. æ•°æ®æµç¨‹

### 4.1 å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥éœ€æ±‚
    â†“
Agentæ”¶é›†ä¿¡æ¯
    â†“
ç¡®è®¤éœ€æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Itinerary Generator (è¡Œç¨‹ç”Ÿæˆå™¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: è·¨åŸäº¤é€šè§„åˆ’                      â”‚
â”‚ - è°ƒç”¨ InterCityTransportService         â”‚
â”‚ - è¿”å›: é£æœº/é«˜é“/è‡ªé©¾æ–¹æ¡ˆ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æ™¯ç‚¹æ¨è                          â”‚
â”‚ - è°ƒç”¨ RAGRetriever                      â”‚
â”‚ - è¾“å…¥: åŸå¸‚ã€åå¥½ã€é¢„ç®—                  â”‚
â”‚ - è¿”å›: Top 15 æ™¯ç‚¹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æ™¯ç‚¹èšç±» (æŒ‰å¤©åˆ†é…)               â”‚
â”‚ - ä½¿ç”¨ K-means åœ°ç†èšç±»                  â”‚
â”‚ - æ¯å¤© 3-4 ä¸ªæ™¯ç‚¹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ç¾é£Ÿæ¨è (æ¯å¤©)                   â”‚
â”‚ - è°ƒç”¨ FoodRecommendationService         â”‚
â”‚ - è¾“å…¥: å½“å¤©æ™¯ç‚¹åæ ‡                      â”‚
â”‚ - è¿”å›: é™„è¿‘é¤å… (åˆé¤+æ™šé¤)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: ä½å®¿æ¨è                          â”‚
â”‚ - è°ƒç”¨ AccommodationService              â”‚
â”‚ - è¾“å…¥: æ‰€æœ‰æ™¯ç‚¹åæ ‡                      â”‚
â”‚ - è¿”å›: ä¸­å¿ƒä½ç½®é…’åº—                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: å¸‚å†…äº¤é€šè§„åˆ’ (å¯é€‰)               â”‚
â”‚ - è°ƒç”¨ IntraCityRouteOptimizer           â”‚
â”‚ - è¾“å…¥: é…’åº—+æ™¯ç‚¹+é¤å…åæ ‡                â”‚
â”‚ - è¿”å›: æ¯æ—¥ä¼˜åŒ–è·¯çº¿                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: é¢„ç®—è®¡ç®—                          â”‚
â”‚ - äº¤é€šè´¹: è·¨åŸ+å¸‚å†…                       â”‚
â”‚ - é—¨ç¥¨è´¹: æ™¯ç‚¹é—¨ç¥¨æ€»å’Œ                    â”‚
â”‚ - é¤é¥®è´¹: é¤å…äººå‡Ã—äººæ•°Ã—é¤æ•°              â”‚
â”‚ - ä½å®¿è´¹: é…’åº—ä»·æ ¼Ã—æ™šæ•°                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç”Ÿæˆå®Œæ•´è¡Œç¨‹
    â†“
è¿”å›ç»™ç”¨æˆ·
```

### 4.2 æ•°æ®æµè½¬ç¤ºä¾‹

**è¾“å…¥**:
```json
{
  "destination": "æ­å·",
  "departure_city": "åŒ—äº¬",
  "days": 3,
  "budget": 5000,
  "preferences": ["æ–‡åŒ–", "ç¾é£Ÿ"],
  "companions_count": 2,
  "travel_dates": "2025-12-01"
}
```

**Step 1 è¾“å‡º** (è·¨åŸäº¤é€š):
```json
{
  "outbound": {
    "method": "é£æœº",
    "cost": 800,
    "duration_hours": 2.5
  },
  "return": {
    "method": "é«˜é“",
    "cost": 600,
    "duration_hours": 5
  }
}
```

**Step 2 è¾“å‡º** (æ™¯ç‚¹):
```json
[
  {"name": "è¥¿æ¹–", "rating": 4.8, "ticket_price": 0, "location": {...}},
  {"name": "çµéšå¯º", "rating": 4.7, "ticket_price": 75, "location": {...}},
  ...
]
```

**Step 3 è¾“å‡º** (æŒ‰å¤©åˆ†é…):
```json
{
  "day1": ["è¥¿æ¹–", "é›·å³°å¡”", "æ²³åŠè¡—"],
  "day2": ["çµéšå¯º", "é£æ¥å³°", "é¾™äº•æ‘"],
  "day3": ["è¥¿æºªæ¹¿åœ°", "å®‹åŸ"]
}
```

**Step 4 è¾“å‡º** (ç¾é£Ÿ):
```json
{
  "day1": {
    "lunch": {"name": "å¤–å©†å®¶", "avg_price": 80},
    "dinner": {"name": "æ¥¼å¤–æ¥¼", "avg_price": 150}
  },
  ...
}
```

**Step 5 è¾“å‡º** (ä½å®¿):
```json
{
  "hotel": "å¦‚å®¶é…’åº—(è¥¿æ¹–åº—)",
  "price_per_night": 300,
  "nights": 2,
  "total_cost": 600
}
```

**æœ€ç»ˆè¾“å‡º**:
```json
{
  "destination": "æ­å·",
  "duration_days": 3,
  "total_budget": 5000,
  "estimated_cost": 4650,
  "transport": {...},
  "daily_plans": [
    {
      "day": 1,
      "attractions": [...],
      "restaurants": [...],
      "route": {...}
    },
    ...
  ],
  "accommodation": {...},
  "budget_breakdown": {
    "transport": 1400,
    "attractions": 450,
    "food": 1200,
    "accommodation": 600,
    "misc": 1000
  }
}
```

---

## 5. å®ç°ç»†èŠ‚

### 5.1 æ¨¡å—1: è·¨åŸäº¤é€šå®ç°

**æ–‡ä»¶**: `backend/tools/transport.py`

```python
import requests
from typing import List, Dict
from dataclasses import dataclass
from config.settings import settings

@dataclass
class TransportOption:
    method: str
    duration_hours: float
    cost_per_person: float
    total_cost: float
    departure_time: str
    arrival_time: str
    description: str
    recommendation_score: float
    details: Dict

class InterCityTransportService:
    """è·¨åŸäº¤é€šæœåŠ¡"""
    
    def __init__(self):
        self.amap_key = settings.AMAP_API_KEY
        
    def get_transport_options(
        self,
        departure_city: str,
        destination_city: str,
        travel_date: str = None,
        companions_count: int = 1
    ) -> List[TransportOption]:
        """è·å–è·¨åŸäº¤é€šæ–¹æ¡ˆ"""
        
        # 1. è·å–ä¸¤åœ°è·ç¦»
        distance_km = self._get_distance(departure_city, destination_city)
        
        # 2. ç”Ÿæˆäº¤é€šæ–¹æ¡ˆ
        options = []
        
        # é£æœºæ–¹æ¡ˆ
        if distance_km > 500:
            flight = self._generate_flight_option(
                departure_city, destination_city, 
                distance_km, companions_count
            )
            options.append(flight)
        
        # é«˜é“æ–¹æ¡ˆ
        if distance_km < 1500:
            train = self._generate_train_option(
                departure_city, destination_city,
                distance_km, companions_count
            )
            options.append(train)
        
        # è‡ªé©¾æ–¹æ¡ˆ
        if distance_km < 800:
            drive = self._generate_drive_option(
                departure_city, destination_city,
                distance_km, companions_count
            )
            options.append(drive)
        
        # 3. æŒ‰æ¨èåº¦æ’åº
        options.sort(key=lambda x: x.recommendation_score, reverse=True)
        
        return options
    
    def _get_distance(self, city1: str, city2: str) -> float:
        """è·å–ä¸¤åœ°è·ç¦»ï¼ˆä½¿ç”¨é«˜å¾·APIï¼‰"""
        # åŸå¸‚ä¸­å¿ƒåæ ‡æ˜ å°„
        city_coords = {
            "åŒ—äº¬": "116.407526,39.904030",
            "ä¸Šæµ·": "121.473701,31.230416",
            "æ­å·": "120.153576,30.287459",
            "å¹¿å·": "113.264385,23.129112",
            "æ·±åœ³": "114.057868,22.543099",
            # ... æ›´å¤šåŸå¸‚
        }
        
        origin = city_coords.get(city1)
        destination = city_coords.get(city2)
        
        if not origin or not destination:
            return 0
        
        # è°ƒç”¨é«˜å¾·åœ°å›¾API
        url = "https://restapi.amap.com/v3/distance"
        params = {
            "key": self.amap_key,
            "origins": origin,
            "destination": destination,
            "type": 1  # é©¾è½¦è·ç¦»
        }
        
        try:
            response = requests.get(url, params=params, timeout=5)
            data = response.json()
            if data["status"] == "1":
                distance_m = int(data["results"][0]["distance"])
                return distance_m / 1000  # è½¬ä¸ºå…¬é‡Œ
        except Exception as e:
            print(f"è·å–è·ç¦»å¤±è´¥: {e}")
        
        return 0
    
    def _generate_flight_option(
        self, 
        departure: str, 
        destination: str,
        distance_km: float,
        companions_count: int
    ) -> TransportOption:
        """ç”Ÿæˆé£æœºæ–¹æ¡ˆ"""
        # è´¹ç”¨ä¼°ç®—
        base_price = distance_km * 0.8  # 0.8å…ƒ/km
        cost_per_person = base_price
        total_cost = cost_per_person * companions_count
        
        # æ—¶é•¿ä¼°ç®—
        flight_time = distance_km / 800  # 800km/h
        total_time = flight_time + 2  # åŠ ä¸Šå€¼æœºã€å€™æœºæ—¶é—´
        
        # æ¨èåˆ†æ•°
        score = 0.9 if distance_km > 800 else 0.6
        
        return TransportOption(
            method="é£æœº",
            duration_hours=round(total_time, 1),
            cost_per_person=round(cost_per_person),
            total_cost=round(total_cost),
            departure_time="å»ºè®®æ—©ç­æœº 08:00-10:00",
            arrival_time=f"çº¦ {round(total_time, 1)} å°æ—¶ååˆ°è¾¾",
            description=f"æœ€å¿«æ·çš„æ–¹å¼ï¼Œé€‚åˆ{distance_km}kmçš„é•¿é€”æ—…è¡Œ",
            recommendation_score=score,
            details={
                "airline": "å‚è€ƒèˆªç­: å›½èˆª/ä¸œèˆª/å—èˆª",
                "airport": f"{departure}æœºåœº â†’ {destination}æœºåœº",
                "booking_tip": "å»ºè®®æå‰7-15å¤©é¢„è®¢ï¼Œä»·æ ¼æ›´ä¼˜æƒ "
            }
        )
    
    def _generate_train_option(
        self,
        departure: str,
        destination: str,
        distance_km: float,
        companions_count: int
    ) -> TransportOption:
        """ç”Ÿæˆé«˜é“æ–¹æ¡ˆ"""
        # è´¹ç”¨ä¼°ç®—
        base_price = distance_km * 0.5  # 0.5å…ƒ/km (äºŒç­‰åº§)
        cost_per_person = base_price
        total_cost = cost_per_person * companions_count
        
        # æ—¶é•¿ä¼°ç®—
        train_time = distance_km / 250  # 250km/h (é«˜é“å¹³å‡é€Ÿåº¦)
        
        # æ¨èåˆ†æ•°
        score = 0.95 if 300 <= distance_km <= 1200 else 0.7
        
        return TransportOption(
            method="é«˜é“",
            duration_hours=round(train_time, 1),
            cost_per_person=round(cost_per_person),
            total_cost=round(total_cost),
            departure_time="å»ºè®®ä¸Šåˆç­æ¬¡ 08:00-10:00",
            arrival_time=f"çº¦ {round(train_time, 1)} å°æ—¶ååˆ°è¾¾",
            description=f"èˆ’é€‚ä¾¿æ·ï¼Œæ€§ä»·æ¯”é«˜ï¼Œé€‚åˆ{distance_km}kmçš„ä¸­é•¿é€”æ—…è¡Œ",
            recommendation_score=score,
            details={
                "train_type": "Gå­—å¤´é«˜é“",
                "seat_type": "äºŒç­‰åº§",
                "station": f"{departure}ç«™ â†’ {destination}ç«™",
                "booking_tip": "12306å®˜ç½‘/Appè´­ç¥¨ï¼Œæ”¯æŒæ”¹ç­¾"
            }
        )
    
    def _generate_drive_option(
        self,
        departure: str,
        destination: str,
        distance_km: float,
        companions_count: int
    ) -> TransportOption:
        """ç”Ÿæˆè‡ªé©¾æ–¹æ¡ˆ"""
        # è´¹ç”¨ä¼°ç®—
        fuel_cost = distance_km * 0.6  # æ²¹è´¹
        toll_fee = distance_km * 0.4  # è¿‡è·¯è´¹
        total_cost = fuel_cost + toll_fee
        
        # æ—¶é•¿ä¼°ç®—
        drive_time = distance_km / 80  # 80km/h (é«˜é€Ÿå¹³å‡é€Ÿåº¦)
        
        # æ¨èåˆ†æ•°
        score = 0.8 if distance_km < 500 else 0.5
        
        return TransportOption(
            method="è‡ªé©¾",
            duration_hours=round(drive_time, 1),
            cost_per_person=round(total_cost / companions_count),
            total_cost=round(total_cost),
            departure_time="å»ºè®®æ—©æ™¨å‡ºå‘ 07:00-08:00",
            arrival_time=f"çº¦ {round(drive_time, 1)} å°æ—¶ååˆ°è¾¾",
            description=f"è‡ªç”±çµæ´»ï¼Œé€‚åˆ{companions_count}äººåŒè¡Œï¼Œ{distance_km}kmè·¯ç¨‹",
            recommendation_score=score,
            details={
                "distance_km": distance_km,
                "fuel_cost": round(fuel_cost),
                "toll_fee": round(toll_fee),
                "route_tip": "å»ºè®®ä½¿ç”¨é«˜å¾·/ç™¾åº¦åœ°å›¾å¯¼èˆª",
                "rest_tip": "æ¯2å°æ—¶ä¼‘æ¯ä¸€æ¬¡ï¼Œæ³¨æ„å®‰å…¨"
            }
        )
```

---

### 5.2 æ¨¡å—3: ç¾é£Ÿæ¨èå®ç°

**æ–‡ä»¶**: `backend/tools/food.py`

```python
import requests
from typing import List, Dict
from dataclasses import dataclass
from config.settings import settings
import math

@dataclass
class Restaurant:
    name: str
    cuisine_type: str
    rating: float
    avg_price: float
    location: Dict
    distance_km: float
    signature_dishes: List[str]
    description: str
    opening_hours: str
    tags: List[str]
    phone: str

class FoodRecommendationService:
    """ç¾é£Ÿæ¨èæœåŠ¡"""
    
    def __init__(self):
        self.amap_key = settings.AMAP_API_KEY
        # é¢„åŠ è½½æœ¬åœ°é¤å…æ•°æ®ï¼ˆçˆ¬å–çš„æ•°æ®ï¼‰
        self.local_restaurants = self._load_local_data()
    
    def get_nearby_restaurants(
        self,
        location: Dict,
        radius_km: float = 2.0,
        cuisine_type: List[str] = None,
        budget_per_person: float = 100,
        top_k: int = 5
    ) -> List[Restaurant]:
        """æŸ¥è¯¢é™„è¿‘ç¾é£Ÿåº—é“º"""
        
        # æ–¹æ¡ˆA: ä½¿ç”¨é«˜å¾·åœ°å›¾APIï¼ˆå®æ—¶æŸ¥è¯¢ï¼‰
        restaurants = self._search_by_amap(location, radius_km)
        
        # æ–¹æ¡ˆB: ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼ˆfallbackï¼‰
        if not restaurants:
            restaurants = self._search_by_local(location, radius_km)
        
        # è¿‡æ»¤å’Œæ’åº
        filtered = self._filter_restaurants(
            restaurants, cuisine_type, budget_per_person
        )
        
        # æ’åº
        sorted_restaurants = self._rank_restaurants(filtered, location)
        
        return sorted_restaurants[:top_k]
    
    def _search_by_amap(
        self, 
        location: Dict, 
        radius_km: float
    ) -> List[Restaurant]:
        """ä½¿ç”¨é«˜å¾·åœ°å›¾APIæœç´¢"""
        url = "https://restapi.amap.com/v3/place/around"
        params = {
            "key": self.amap_key,
            "location": f"{location['lng']},{location['lat']}",
            "keywords": "é¤å…|ç¾é£Ÿ",
            "types": "050000",  # é¤é¥®æœåŠ¡
            "radius": int(radius_km * 1000),
            "offset": 20,
            "extensions": "all"
        }
        
        try:
            response = requests.get(url, params=params, timeout=5)
            data = response.json()
            
            if data["status"] == "1":
                pois = data.get("pois", [])
                return [self._parse_amap_poi(poi, location) for poi in pois]
        except Exception as e:
            print(f"é«˜å¾·APIæŸ¥è¯¢å¤±è´¥: {e}")
        
        return []
    
    def _parse_amap_poi(self, poi: Dict, center: Dict) -> Restaurant:
        """è§£æé«˜å¾·POIæ•°æ®"""
        lng, lat = map(float, poi["location"].split(","))
        poi_location = {"lat": lat, "lng": lng, "address": poi.get("address", "")}
        
        distance = self._calculate_distance(center, poi_location)
        
        return Restaurant(
            name=poi["name"],
            cuisine_type=poi.get("type", "é¤å…"),
            rating=float(poi.get("rating", 4.0)),
            avg_price=self._estimate_price(poi),
            location=poi_location,
            distance_km=distance,
            signature_dishes=[],
            description=poi.get("business_area", ""),
            opening_hours=poi.get("opentime", "è¥ä¸šä¸­"),
            tags=[],
            phone=poi.get("tel", "")
        )
    
    def _search_by_local(
        self, 
        location: Dict, 
        radius_km: float
    ) -> List[Restaurant]:
        """ä½¿ç”¨æœ¬åœ°æ•°æ®æœç´¢"""
        nearby = []
        
        for restaurant in self.local_restaurants:
            distance = self._calculate_distance(location, restaurant.location)
            if distance <= radius_km:
                restaurant.distance_km = distance
                nearby.append(restaurant)
        
        return nearby
    
    def _calculate_distance(self, loc1: Dict, loc2: Dict) -> float:
        """è®¡ç®—ä¸¤ç‚¹è·ç¦»ï¼ˆHaversineå…¬å¼ï¼‰"""
        lat1, lng1 = loc1["lat"], loc1["lng"]
        lat2, lng2 = loc2["lat"], loc2["lng"]
        
        R = 6371  # åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
        
        dlat = math.radians(lat2 - lat1)
        dlng = math.radians(lng2 - lng1)
        
        a = (math.sin(dlat / 2) ** 2 +
             math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) *
             math.sin(dlng / 2) ** 2)
        
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
        
        return R * c
    
    def _filter_restaurants(
        self,
        restaurants: List[Restaurant],
        cuisine_type: List[str],
        budget: float
    ) -> List[Restaurant]:
        """è¿‡æ»¤é¤å…"""
        filtered = restaurants
        
        # æŒ‰èœç³»è¿‡æ»¤
        if cuisine_type:
            filtered = [r for r in filtered 
                       if any(ct in r.cuisine_type for ct in cuisine_type)]
        
        # æŒ‰é¢„ç®—è¿‡æ»¤ï¼ˆÂ±30%ï¼‰
        filtered = [r for r in filtered 
                   if budget * 0.7 <= r.avg_price <= budget * 1.3]
        
        return filtered
    
    def _rank_restaurants(
        self,
        restaurants: List[Restaurant],
        center: Dict
    ) -> List[Restaurant]:
        """é¤å…æ’åº"""
        def score(r: Restaurant) -> float:
            # è¯„åˆ†æƒé‡
            rating_score = r.rating / 5.0 * 0.4
            
            # è·ç¦»æƒé‡ï¼ˆè¶Šè¿‘è¶Šå¥½ï¼‰
            distance_score = (1 / (r.distance_km + 0.1)) * 0.3
            
            # ä»·æ ¼æƒé‡ï¼ˆé€‚ä¸­æœ€å¥½ï¼‰
            price_score = 0.2
            
            # çƒ­åº¦æƒé‡
            popularity_score = len(r.tags) / 5 * 0.1
            
            return rating_score + distance_score + price_score + popularity_score
        
        restaurants.sort(key=score, reverse=True)
        return restaurants
    
    def _load_local_data(self) -> List[Restaurant]:
        """åŠ è½½æœ¬åœ°é¤å…æ•°æ®"""
        # TODO: ä»JSONæ–‡ä»¶åŠ è½½çˆ¬å–çš„é¤å…æ•°æ®
        return []
    
    def _estimate_price(self, poi: Dict) -> float:
        """ä¼°ç®—äººå‡ä»·æ ¼"""
        # æ ¹æ®POIç±»å‹ä¼°ç®—
        type_name = poi.get("type", "")
        if "å¿«é¤" in type_name or "å°åƒ" in type_name:
            return 30
        elif "ç«é”…" in type_name or "çƒ§çƒ¤" in type_name:
            return 80
        elif "è¥¿é¤" in type_name or "æ—¥æ–™" in type_name:
            return 120
        else:
            return 60
```

---

### 5.3 æ¨¡å—4: ä½å®¿æ¨èå®ç°

**æ–‡ä»¶**: `backend/tools/accommodation.py`

```python
import json
from typing import List, Dict
from dataclasses import dataclass
from math import ceil

@dataclass
class Hotel:
    name: str
    hotel_type: str
    rating: float
    price_per_night: float
    location: Dict
    distance_to_center: float
    facilities: List[str]
    room_type: str
    description: str
    tags: List[str]
    phone: str
    total_cost: float

class AccommodationService:
    """ä½å®¿æ¨èæœåŠ¡"""
    
    def __init__(self):
        # åŠ è½½æœ¬åœ°é…’åº—æ•°æ®
        self.hotels_db = self._load_hotels_data()
    
    def get_hotels_in_area(
        self,
        city: str,
        poi_list: List[Dict],
        budget_per_night: float,
        nights: int,
        companions_count: int = 1,
        top_k: int = 5
    ) -> List[Hotel]:
        """æŸ¥è¯¢åŒºåŸŸå†…é…’åº—"""
        
        # 1. è®¡ç®—POIä¸­å¿ƒç‚¹
        center = self._calculate_center(poi_list)
        
        # 2. ç¡®å®šé…’åº—æ¡£æ¬¡
        hotel_level = self._determine_hotel_level(budget_per_night)
        
        # 3. è·å–å€™é€‰é…’åº—
        candidates = self.hotels_db.get(city, {}).get(hotel_level, [])
        
        # 4. è®¡ç®—è·ç¦»
        for hotel in candidates:
            hotel.distance_to_center = self._calculate_distance(
                center, hotel.location
            )
        
        # 5. è¿‡æ»¤å’Œæ’åº
        filtered = [h for h in candidates 
                   if abs(h.price_per_night - budget_per_night) < budget_per_night * 0.3]
        
        ranked = self._rank_hotels(filtered, budget_per_night)
        
        # 6. è®¡ç®—æ€»è´¹ç”¨
        for hotel in ranked:
            hotel.total_cost = hotel.price_per_night * nights
        
        return ranked[:top_k]
    
    def _calculate_center(self, poi_list: List[Dict]) -> Dict:
        """è®¡ç®—POIä¸­å¿ƒç‚¹"""
        if not poi_list:
            return {"lat": 0, "lng": 0}
        
        avg_lat = sum(poi["lat"] for poi in poi_list) / len(poi_list)
        avg_lng = sum(poi["lng"] for poi in poi_list) / len(poi_list)
        
        return {"lat": avg_lat, "lng": avg_lng}
    
    def _determine_hotel_level(self, budget: float) -> str:
        """ç¡®å®šé…’åº—æ¡£æ¬¡"""
        if budget < 250:
            return "economic"
        elif budget < 500:
            return "standard"
        else:
            return "premium"
    
    def _rank_hotels(
        self, 
        hotels: List[Hotel], 
        budget: float
    ) -> List[Hotel]:
        """é…’åº—æ’åº"""
        def score(h: Hotel) -> float:
            # è¯„åˆ†
            rating_score = h.rating / 5.0 * 0.3
            
            # ä»·æ ¼åŒ¹é…åº¦
            price_diff = abs(h.price_per_night - budget) / budget
            price_score = (1 - price_diff) * 0.3
            
            # è·ç¦»ï¼ˆè¶Šè¿‘è¶Šå¥½ï¼‰
            distance_score = (1 / (h.distance_to_center + 0.1)) * 0.25
            
            # è®¾æ–½å®Œå–„åº¦
            facility_score = len(h.facilities) / 10 * 0.15
            
            return rating_score + price_score + distance_score + facility_score
        
        hotels.sort(key=score, reverse=True)
        return hotels
    
    def _calculate_distance(self, loc1: Dict, loc2: Dict) -> float:
        """è®¡ç®—è·ç¦»ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
        # ä½¿ç”¨Haversineå…¬å¼ï¼ˆåŒç¾é£Ÿæ¨èæ¨¡å—ï¼‰
        import math
        
        lat1, lng1 = loc1["lat"], loc1["lng"]
        lat2, lng2 = loc2["lat"], loc2["lng"]
        
        R = 6371
        dlat = math.radians(lat2 - lat1)
        dlng = math.radians(lng2 - lng1)
        
        a = (math.sin(dlat / 2) ** 2 +
             math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) *
             math.sin(dlng / 2) ** 2)
        
        c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
        
        return R * c
    
    def _load_hotels_data(self) -> Dict:
        """åŠ è½½é…’åº—æ•°æ®"""
        # TODO: ä»JSONæ–‡ä»¶åŠ è½½
        # æ•°æ®æ ¼å¼: data/hotels/{city}.json
        return {
            "æ­å·": {
                "economic": [],
                "standard": [],
                "premium": []
            }
        }
```

---

## 6. æŠ€æœ¯é€‰å‹

### 6.1 APIæœåŠ¡é€‰æ‹©

| åŠŸèƒ½ | æœåŠ¡å•† | å…è´¹é¢åº¦ | å¤‡é€‰æ–¹æ¡ˆ |
|-----|--------|---------|---------|
| åœ°å›¾è·¯å¾„è§„åˆ’ | é«˜å¾·åœ°å›¾ | 30ä¸‡æ¬¡/å¤© | ç™¾åº¦åœ°å›¾ |
| POIæœç´¢ | é«˜å¾·åœ°å›¾ | 30ä¸‡æ¬¡/å¤© | ç™¾åº¦åœ°å›¾ |
| æ™¯ç‚¹æ•°æ® | ChromaDB | æ— é™åˆ¶ | - |
| ç¾é£Ÿæ•°æ® | é«˜å¾·API | 30ä¸‡æ¬¡/å¤© | æœ¬åœ°çˆ¬å–æ•°æ® |
| é…’åº—æ•°æ® | æœ¬åœ°çˆ¬å– | - | é«˜å¾·API |
| äº¤é€šç¥¨ä»· | è§„åˆ™ä¼°ç®— | - | 12306/æºç¨‹API |

### 6.2 æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

```
data/
â”œâ”€â”€ attractions/          # æ™¯ç‚¹æ•°æ®ï¼ˆJSON + å‘é‡åº“ï¼‰
â”‚   â”œâ”€â”€ guangdong.json
â”‚   â”œâ”€â”€ jiangsu.json
â”‚   â””â”€â”€ zhejiang.json
â”‚
â”œâ”€â”€ restaurants/         # é¤å…æ•°æ®ï¼ˆçˆ¬å–ï¼‰
â”‚   â”œâ”€â”€ guangzhou.json
â”‚   â”œâ”€â”€ hangzhou.json
â”‚   â””â”€â”€ suzhou.json
â”‚
â”œâ”€â”€ hotels/             # é…’åº—æ•°æ®ï¼ˆçˆ¬å–ï¼‰
â”‚   â”œâ”€â”€ guangzhou.json
â”‚   â”œâ”€â”€ hangzhou.json
â”‚   â””â”€â”€ suzhou.json
â”‚
â””â”€â”€ vector_db/          # ChromaDBå‘é‡åº“
    â””â”€â”€ chroma/
```

### 6.3 ç®—æ³•é€‰æ‹©

| åŠŸèƒ½ | ç®—æ³• | å¤æ‚åº¦ |
|-----|------|--------|
| æ™¯ç‚¹èšç±» | K-means | O(nÃ—kÃ—i) |
| è·¯çº¿ä¼˜åŒ– | è´ªå¿ƒ + 2-opt | O(nÂ²) |
| æ¨èæ’åº | åŠ æƒè¯„åˆ† | O(n log n) |

---

## 7. å¼€å‘è®¡åˆ’

### 7.1 æ—¶é—´å®‰æ’ï¼ˆ10å¤©ï¼‰

| é˜¶æ®µ | ä»»åŠ¡ | è´Ÿè´£äºº | æ—¶é—´ |
|-----|------|--------|------|
| **Day 1-2** | è·¨åŸäº¤é€šæ¨¡å— | æˆå‘˜C | 2å¤© |
| | - é«˜å¾·APIé›†æˆ | | |
| | - äº¤é€šæ–¹æ¡ˆç”Ÿæˆç®—æ³• | | |
| | - è´¹ç”¨ä¼°ç®—é€»è¾‘ | | |
| **Day 3-4** | æ™¯ç‚¹RAGç³»ç»Ÿ | æˆå‘˜B | 2å¤© |
| | - æ•°æ®çˆ¬å–å’Œæ¸…æ´— | | |
| | - å‘é‡åŒ–å’Œå­˜å‚¨ | | |
| | - æ£€ç´¢æ¥å£ä¼˜åŒ– | | |
| **Day 5-6** | ç¾é£Ÿ+ä½å®¿æ¨¡å— | æˆå‘˜C | 2å¤© |
| | - ç¾é£Ÿæ¨èæ¥å£ | | |
| | - ä½å®¿æ¨èæ¥å£ | | |
| | - æ•°æ®çˆ¬å– | | |
| **Day 7-8** | è¡Œç¨‹ç”Ÿæˆå™¨é›†æˆ | æˆå‘˜C | 2å¤© |
| | - æ•´åˆæ‰€æœ‰æ¨¡å— | | |
| | - é¢„ç®—è®¡ç®— | | |
| | - è·¯çº¿ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰ | | |
| **Day 9** | å‰ç«¯å±•ç¤º | æˆå‘˜D | 1å¤© |
| | - è¡Œç¨‹è¯¦æƒ…é¡µé¢ | | |
| | - åœ°å›¾å±•ç¤º | | |
| **Day 10** | è”è°ƒæµ‹è¯• | å…¨å‘˜ | 1å¤© |
| | - ç«¯åˆ°ç«¯æµ‹è¯• | | |
| | - Bugä¿®å¤ | | |

### 7.2 ä¼˜å…ˆçº§åˆ’åˆ†

#### **P0ï¼ˆå¿…é¡»å®Œæˆï¼‰**:
- âœ… è·¨åŸäº¤é€šè§„åˆ’
- âœ… æ™¯ç‚¹æ¨èï¼ˆRAGï¼‰
- âœ… é¢„ç®—è®¡ç®—
- âœ… åŸºç¡€è¡Œç¨‹ç”Ÿæˆ

#### **P1ï¼ˆé‡è¦ï¼‰**:
- âœ… ç¾é£Ÿæ¨è
- âœ… ä½å®¿æ¨è
- ğŸ”„ å‰ç«¯åœ°å›¾å±•ç¤º

#### **P2ï¼ˆå¯é€‰ï¼‰**:
- ğŸ”„ å¸‚å†…äº¤é€šä¼˜åŒ–
- ğŸ”„ å®æ—¶ç¥¨ä»·æŸ¥è¯¢
- ğŸ”„ å¤©æ°”é¢„æŠ¥é›†æˆ

### 7.3 é£é™©æ§åˆ¶

| é£é™© | å½±å“ | åº”å¯¹æ–¹æ¡ˆ |
|-----|------|---------|
| APIé¢åº¦ä¸è¶³ | é«˜ | ä½¿ç”¨æœ¬åœ°æ•°æ®fallback |
| æ•°æ®çˆ¬å–å¤±è´¥ | ä¸­ | ä½¿ç”¨ç¤ºä¾‹æ•°æ® |
| ç®—æ³•æ€§èƒ½å·® | ä½ | ç®€åŒ–ç®—æ³•é€»è¾‘ |
| æ—¶é—´ä¸è¶³ | é«˜ | ç æ‰P2åŠŸèƒ½ |

---

## 8. æµ‹è¯•æ–¹æ¡ˆ

### 8.1 å•å…ƒæµ‹è¯•

```python
# test/test_transport.py
def test_transport_service():
    service = InterCityTransportService()
    options = service.get_transport_options("åŒ—äº¬", "æ­å·", companions_count=2)
    assert len(options) > 0
    assert options[0].method in ["é£æœº", "é«˜é“", "è‡ªé©¾"]

# test/test_food.py
def test_food_recommendation():
    service = FoodRecommendationService()
    restaurants = service.get_nearby_restaurants(
        location={"lat": 30.25, "lng": 120.13},
        radius_km=2.0,
        top_k=5
    )
    assert len(restaurants) <= 5
```

### 8.2 é›†æˆæµ‹è¯•

```python
# test/test_itinerary_generation.py
def test_full_itinerary():
    agent = AgentCore()
    response = agent.process_message(
        "test_session",
        "æˆ‘æƒ³ä»åŒ—äº¬å»æ­å·ç©3å¤©ï¼Œé¢„ç®—5000ï¼Œå–œæ¬¢æ–‡åŒ–å’Œç¾é£Ÿ"
    )
    # ... ç¡®è®¤
    assert response["itinerary"] is not None
    assert "transport" in response["itinerary"]
    assert "daily_plans" in response["itinerary"]
```

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒäº®ç‚¹

1. **å®Œæ•´æ€§**: è¦†ç›–äº¤é€šã€æ™¯ç‚¹ã€ç¾é£Ÿã€ä½å®¿ã€è·¯çº¿å…¨æµç¨‹
2. **æ™ºèƒ½åŒ–**: åŸºäºRAGçš„æ™¯ç‚¹æ¨è + LLMå¯¹è¯ç®¡ç†
3. **å®ç”¨æ€§**: çœŸå®API + çˆ¬å–æ•°æ®ï¼Œç»“æœå¯è½åœ°
4. **å¯æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºå¢åŠ æ–°åŠŸèƒ½

### 9.2 åˆ›æ–°ç‚¹

1. **RAGå‘é‡æ£€ç´¢**: è¯­ä¹‰åŒ–æ™¯ç‚¹æ¨è
2. **åŠ¨æ€é¢„ç®—è°ƒæ•´**: æ ¹æ®äººæ•°ã€åŒè¡Œç±»å‹æ™ºèƒ½è°ƒæ•´
3. **POIèšåˆæ¨è**: åŸºäºåœ°ç†ä½ç½®çš„ç¾é£Ÿã€ä½å®¿æ¨è
4. **è·¯çº¿ä¼˜åŒ–ç®—æ³•**: TSP + 2-optä¼˜åŒ–æ¯æ—¥è·¯çº¿

### 9.3 ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

- ğŸ”„ æ¥å…¥å®æ—¶ç¥¨ä»·API
- ğŸ”„ å¢åŠ ç”¨æˆ·è¯„ä»·ç³»ç»Ÿ
- ğŸ”„ æ”¯æŒå¤šåŸå¸‚è”æ¸¸
- ğŸ”„ ç”Ÿæˆå¯å¯¼å‡ºçš„PDFè¡Œç¨‹å•

---

**æ–‡æ¡£å®Œæˆï¼** ğŸ‰

è¿™ä¸ªæ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„æŠ€æœ¯å®ç°è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥æŒ‰ç…§è¿™ä¸ªæ–‡æ¡£è¿›è¡Œå¼€å‘ã€‚

