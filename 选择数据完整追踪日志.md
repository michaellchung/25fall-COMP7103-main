# é€‰æ‹©æ•°æ®å®Œæ•´è¿½è¸ªæ—¥å¿—

## ğŸ“‹ æ—¥å¿—è¿½è¸ªé“¾è·¯

ç°åœ¨å·²ç»åœ¨æ•´ä¸ªæ•°æ®æµä¸­æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—ï¼Œå¯ä»¥å®Œæ•´è¿½è¸ªé€‰æ‹©æ•°æ®çš„ä¼ é€’è¿‡ç¨‹ã€‚

### å®Œæ•´çš„æ—¥å¿—é“¾è·¯

```
å‰ç«¯ç»„ä»¶ â†’ ChatView â†’ Store â†’ API â†’ åç«¯API â†’ AgentCore â†’ çŠ¶æ€ä¿å­˜
```

---

## ğŸ” æ—¥å¿—è¾“å‡ºä½ç½®

### 1. å‰ç«¯ç»„ä»¶å±‚

#### TransportSelector.vue
```javascript
const confirmSelection = () => {
  if (selectedOption.value) {
    emit('select', {
      type: 'transport',
      choice: { ... }
    })
  }
}
```
**æ— Consoleæ—¥å¿—**ï¼ˆå¯ä»¥æ·»åŠ ï¼‰

#### AccommodationSelector.vue
```javascript
const confirmSelection = () => {
  if (!selectedOption.value) {
    console.warn('âš ï¸ æœªé€‰æ‹©é…’åº—')
    return
  }
  
  console.log('ğŸ¨ å‘é€ä½å®¿é€‰æ‹©:', selectedOption.value)
  emit('select', { ... })
}
```
**æ—¥å¿—**: `ğŸ¨ å‘é€ä½å®¿é€‰æ‹©:`

---

### 2. ChatViewå±‚

```javascript
async function handleSelection(selectionData) {
  console.log('ğŸ¯ [ChatView] handleSelectionè¢«è°ƒç”¨')
  console.log('ğŸ“¦ [ChatView] selectionData:', selectionData)
  console.log('ğŸ’¬ [ChatView] message:', selectionData.message)
  console.log('ğŸ [ChatView] choice:', selectionData.choice)
  
  await chatStore.sendMessage(selectionData.message, selectionData.choice)
}
```

**é¢„æœŸæ—¥å¿—**:
```
ğŸ¯ [ChatView] handleSelectionè¢«è°ƒç”¨
ğŸ“¦ [ChatView] selectionData: {type: "transport", choice: {...}, message: "æˆ‘é€‰æ‹©é£æœº"}
ğŸ’¬ [ChatView] message: æˆ‘é€‰æ‹©é£æœº
ğŸ [ChatView] choice: {method: "é£æœº", cost: 800, outbound: {...}, return: {...}}
ğŸ“¤ [ChatView] è°ƒç”¨chatStore.sendMessage
âœ… [ChatView] sendMessageå®Œæˆ
```

---

### 3. Storeå±‚ (chat.js)

```javascript
async function sendMessage(content, selection = null) {
  console.log('ğŸš€ [Store] å‘é€æ¶ˆæ¯å¼€å§‹')
  console.log('ğŸ“ [Store] å†…å®¹:', content)
  console.log('ğŸ“¦ [Store] é€‰æ‹©:', selection)
  
  const requestData = {
    session_id: sessionId.value,
    message: content
  }
  
  if (selection) {
    requestData.selection = selection
  }
  
  console.log('ğŸ“¤ [Store] å‘é€è¯·æ±‚:', requestData)
  const response = await sendMessageAPI(requestData)
  console.log('ğŸ“¥ [Store] æ”¶åˆ°å“åº”:', response)
}
```

**é¢„æœŸæ—¥å¿—**:
```
ğŸš€ [Store] å‘é€æ¶ˆæ¯å¼€å§‹
ğŸ“ [Store] å†…å®¹: æˆ‘é€‰æ‹©é£æœº
ğŸ“¦ [Store] é€‰æ‹©: {method: "é£æœº", cost: 800, ...}
âœ… [Store] ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ 
ğŸ“¤ [Store] å‘é€è¯·æ±‚: {session_id: "...", message: "...", selection: {...}}
ğŸ“¥ [Store] æ”¶åˆ°å“åº”: {data: {...}}
```

---

### 4. APIè°ƒç”¨å±‚ (api/chat.js)

```javascript
export function sendMessage(data) {
  console.log('ğŸŒ [API] sendMessageè¢«è°ƒç”¨')
  console.log('ğŸ“¦ [API] å‘é€çš„æ•°æ®:', data)
  console.log('ğŸ’¬ [API] message:', data.message)
  console.log('ğŸ [API] selection:', data.selection)
  
  return request({ url: '/chat', method: 'post', data })
}
```

**é¢„æœŸæ—¥å¿—**:
```
ğŸŒ [API] sendMessageè¢«è°ƒç”¨
ğŸ“¦ [API] å‘é€çš„æ•°æ®: {session_id: "...", message: "...", selection: {...}}
ğŸ’¬ [API] message: æˆ‘é€‰æ‹©é£æœº
ğŸ [API] selection: {method: "é£æœº", cost: 800, ...}
```

---

### 5. åç«¯APIå±‚ (backend/api/chat.py)

```python
@router.post("/chat")
async def chat(request: ChatRequest) -> ChatResponse:
    logger.info(f"ğŸ“¨ APIæ”¶åˆ°è¯·æ±‚ - session: {request.session_id}")
    logger.info(f"ğŸ’¬ æ¶ˆæ¯å†…å®¹: {request.message}")
    logger.info(f"ğŸ“¦ selectionæ•°æ®: {request.selection}")
    
    result = agent.process_message(
        session_id=request.session_id,
        user_message=request.message,
        selection=request.selection
    )
    
    logger.info(f"âœ… APIè¿”å›æˆåŠŸ")
```

**é¢„æœŸæ—¥å¿—**:
```
ğŸ“¨ APIæ”¶åˆ°è¯·æ±‚ - session: session_xxx
ğŸ’¬ æ¶ˆæ¯å†…å®¹: æˆ‘é€‰æ‹©é£æœº
ğŸ“¦ selectionæ•°æ®: {'method': 'é£æœº', 'cost': 800, ...}
âœ… APIè¿”å›æˆåŠŸ
```

---

### 6. AgentCoreå±‚ (backend/agent/core.py)

#### äº¤é€šé€‰æ‹©å¤„ç†
```python
def _handle_transport_selection(self, state, user_message, selection):
    logger.info(f"å¤„ç†äº¤é€šé€‰æ‹©: {user_message}")
    logger.info(f"ğŸ“¦ æ”¶åˆ°çš„selectionå‚æ•°: {selection}")
    
    if selection and "choice" in selection:
        transport_choice = selection["choice"]
        logger.info(f"âœ… ä»selectionä¸­æå–choice: {transport_choice}")
    else:
        transport_choice = self._parse_transport_selection(user_message)
        logger.info(f"âš ï¸ æœªæ”¶åˆ°selectionï¼Œä»æ¶ˆæ¯ä¸­è§£æ: {transport_choice}")
    
    state.user_selections.transport_choice = transport_choice
    logger.info(f"ğŸ’¾ äº¤é€šé€‰æ‹©å·²ä¿å­˜åˆ°state")
    logger.info(f"ğŸ“Š å®Œæ•´çš„transport_choiceæ•°æ®: {state.user_selections.transport_choice}")
```

**é¢„æœŸæ—¥å¿—**:
```
å¤„ç†äº¤é€šé€‰æ‹©: æˆ‘é€‰æ‹©é£æœº
ğŸ“¦ æ”¶åˆ°çš„selectionå‚æ•°: {'choice': {'method': 'é£æœº', 'cost': 800, ...}}
âœ… ä»selectionä¸­æå–choice: {'method': 'é£æœº', 'cost': 800, ...}
ğŸ’¾ äº¤é€šé€‰æ‹©å·²ä¿å­˜åˆ°state
ğŸ“Š å®Œæ•´çš„transport_choiceæ•°æ®: {'method': 'é£æœº', 'cost': 800, ...}
```

#### ä½å®¿é€‰æ‹©å¤„ç†
```python
def _handle_accommodation_selection(self, state, user_message, selection):
    logger.info(f"å¤„ç†ä½å®¿é€‰æ‹©: {user_message}")
    logger.info(f"ğŸ“¦ æ”¶åˆ°çš„selectionå‚æ•°: {selection}")
    
    if selection and "choice" in selection:
        accommodation_choice = selection["choice"]
        logger.info(f"âœ… ä»selectionä¸­æå–choice: {accommodation_choice}")
    else:
        accommodation_choice = {}
        logger.info(f"âš ï¸ æœªæ”¶åˆ°selectionï¼Œä½¿ç”¨ç©ºå¯¹è±¡")
    
    state.user_selections.accommodation_choice = accommodation_choice
    logger.info(f"ğŸ’¾ ä½å®¿é€‰æ‹©å·²ä¿å­˜åˆ°state")
    logger.info(f"ğŸ“Š å®Œæ•´çš„accommodation_choiceæ•°æ®: {state.user_selections.accommodation_choice}")
```

**é¢„æœŸæ—¥å¿—**:
```
å¤„ç†ä½å®¿é€‰æ‹©: æˆ‘é€‰æ‹©æ­å·è¥¿å­æ¹–å››å­£é…’åº—
ğŸ“¦ æ”¶åˆ°çš„selectionå‚æ•°: {'choice': {'id': 'hz_hotel_001', 'name': 'æ­å·è¥¿å­æ¹–å››å­£é…’åº—', ...}}
âœ… ä»selectionä¸­æå–choice: {'id': 'hz_hotel_001', 'name': 'æ­å·è¥¿å­æ¹–å››å­£é…’åº—', ...}
ğŸ’¾ ä½å®¿é€‰æ‹©å·²ä¿å­˜åˆ°state
ğŸ“Š å®Œæ•´çš„accommodation_choiceæ•°æ®: {'id': 'hz_hotel_001', 'name': 'æ­å·è¥¿å­æ¹–å››å­£é…’åº—', ...}
```

---

## ğŸ” å¦‚ä½•ä½¿ç”¨è¿™äº›æ—¥å¿—è°ƒè¯•

### æ­¥éª¤1: æ‰“å¼€æµè§ˆå™¨Console

1. æŒ‰ `F12` æˆ– `Cmd+Option+I`
2. åˆ‡æ¢åˆ° **Console** æ ‡ç­¾
3. æ¸…ç©ºConsole (`Cmd+K` æˆ–ç‚¹å‡»æ¸…ç©ºæŒ‰é’®)

### æ­¥éª¤2: è¿›è¡Œæ“ä½œ

1. åˆ·æ–°é¡µé¢
2. å®Œæˆéœ€æ±‚æ”¶é›†
3. **é€‰æ‹©äº¤é€š** - ç‚¹å‡»ä¸€ä¸ªäº¤é€šå¡ç‰‡ï¼Œç„¶åç‚¹"ç¡®è®¤é€‰æ‹©"
4. è§‚å¯ŸConsoleè¾“å‡º

### æ­¥éª¤3: æ£€æŸ¥æ—¥å¿—

#### å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ¨ å‘é€ä½å®¿é€‰æ‹©: {method: "é£æœº", ...}
ğŸ¯ [ChatView] handleSelectionè¢«è°ƒç”¨
ğŸ“¦ [ChatView] selectionData: {type: "transport", choice: {...}, message: "æˆ‘é€‰æ‹©é£æœº"}
ğŸ’¬ [ChatView] message: æˆ‘é€‰æ‹©é£æœº
ğŸ [ChatView] choice: {method: "é£æœº", cost: 800, ...}
ğŸ“¤ [ChatView] è°ƒç”¨chatStore.sendMessage
ğŸš€ [Store] å‘é€æ¶ˆæ¯å¼€å§‹
ğŸ“ [Store] å†…å®¹: æˆ‘é€‰æ‹©é£æœº
ğŸ“¦ [Store] é€‰æ‹©: {method: "é£æœº", cost: 800, ...}
âœ… [Store] ç”¨æˆ·æ¶ˆæ¯å·²æ·»åŠ 
ğŸ“¤ [Store] å‘é€è¯·æ±‚: {session_id: "...", message: "...", selection: {...}}
ğŸŒ [API] sendMessageè¢«è°ƒç”¨
ğŸ“¦ [API] å‘é€çš„æ•°æ®: {session_id: "...", message: "...", selection: {...}}
ğŸ“¥ [Store] æ”¶åˆ°å“åº”: {...}
âœ… [ChatView] sendMessageå®Œæˆ
```

#### å¦‚æœæŸä¸ªç¯èŠ‚ç¼ºå¤±ï¼Œè¯´æ˜é—®é¢˜å‡ºåœ¨é‚£é‡Œï¼š

**æƒ…å†µ1**: æ²¡æœ‰çœ‹åˆ° `ğŸ¯ [ChatView] handleSelectionè¢«è°ƒç”¨`
- **é—®é¢˜**: ç»„ä»¶çš„emitæ²¡æœ‰è§¦å‘æˆ–ChatViewæ²¡æœ‰ç›‘å¬
- **æ£€æŸ¥**: ç»„ä»¶æ˜¯å¦æ­£ç¡®ç»‘å®šäº†`@select`äº‹ä»¶

**æƒ…å†µ2**: çœ‹åˆ°äº†ChatViewæ—¥å¿—ï¼Œä½†`choice`æ˜¯`undefined`æˆ–`{}`
- **é—®é¢˜**: ç»„ä»¶emitçš„æ•°æ®ç»“æ„ä¸å¯¹
- **æ£€æŸ¥**: ç»„ä»¶çš„`confirmSelection`æ–¹æ³•

**æƒ…å†µ3**: çœ‹åˆ°äº†Storeæ—¥å¿—ï¼Œä½†`selection`æ˜¯`null`
- **é—®é¢˜**: ChatViewä¼ é€’å‚æ•°æ—¶ä¸¢å¤±äº†
- **æ£€æŸ¥**: `chatStore.sendMessage`çš„è°ƒç”¨

**æƒ…å†µ4**: å‰ç«¯æ—¥å¿—éƒ½æ­£å¸¸ï¼Œä½†åç«¯æ²¡æœ‰æ—¥å¿—
- **é—®é¢˜**: ç½‘ç»œè¯·æ±‚å¤±è´¥æˆ–åç«¯æœªè¿è¡Œ
- **æ£€æŸ¥**: Networkæ ‡ç­¾ï¼ŒæŸ¥çœ‹è¯·æ±‚çŠ¶æ€

---

### æ­¥éª¤4: æ£€æŸ¥åç«¯æ—¥å¿—

åœ¨åç«¯ç»ˆç«¯ä¸­æŸ¥çœ‹ï¼š

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f /Applications/MyDocument/7103/backend/backend.log

# æˆ–è€…æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -50 /Applications/MyDocument/7103/backend/backend.log
```

**åº”è¯¥çœ‹åˆ°**:
```
ğŸ“¨ APIæ”¶åˆ°è¯·æ±‚ - session: session_xxx
ğŸ’¬ æ¶ˆæ¯å†…å®¹: æˆ‘é€‰æ‹©é£æœº
ğŸ“¦ selectionæ•°æ®: {'choice': {'method': 'é£æœº', ...}}
å¤„ç†äº¤é€šé€‰æ‹©: æˆ‘é€‰æ‹©é£æœº
ğŸ“¦ æ”¶åˆ°çš„selectionå‚æ•°: {'choice': {'method': 'é£æœº', ...}}
âœ… ä»selectionä¸­æå–choice: {'method': 'é£æœº', ...}
ğŸ’¾ äº¤é€šé€‰æ‹©å·²ä¿å­˜åˆ°state
ğŸ“Š å®Œæ•´çš„transport_choiceæ•°æ®: {'method': 'é£æœº', ...}
```

---

## ğŸ› å¸¸è§é—®é¢˜è¯Šæ–­

### é—®é¢˜1: å‰ç«¯æ²¡æœ‰ä»»ä½•æ—¥å¿—

**å¯èƒ½åŸå› **:
- ç»„ä»¶çš„`confirmSelection`æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨
- æ²¡æœ‰é€‰ä¸­é€‰é¡¹å°±ç‚¹å‡»äº†ç¡®è®¤

**è§£å†³**:
- ç¡®ä¿ç‚¹å‡»äº†å¡ç‰‡ï¼ˆå¡ç‰‡åº”è¯¥é«˜äº®ï¼‰
- ç„¶åå†ç‚¹å‡»"ç¡®è®¤é€‰æ‹©"æŒ‰é’®

---

### é—®é¢˜2: å‰ç«¯æœ‰æ—¥å¿—ï¼Œä½†`choice`æ˜¯ç©ºå¯¹è±¡

**å¯èƒ½åŸå› **:
- `selectedOption.value`æ˜¯`null`æˆ–`undefined`
- ç»„ä»¶çš„æ•°æ®ç»“æ„ä¸å¯¹

**è§£å†³**:
- æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å¡ç‰‡
- æŸ¥çœ‹`selectedOption.value`çš„å€¼

---

### é—®é¢˜3: åç«¯æ”¶åˆ°çš„`selection`æ˜¯`None`

**å¯èƒ½åŸå› **:
- å‰ç«¯æ²¡æœ‰ä¼ é€’`selection`å‚æ•°
- APIè°ƒç”¨æ—¶å‚æ•°ä¸¢å¤±

**è§£å†³**:
- æ£€æŸ¥`api/chat.js`çš„æ—¥å¿—
- ç¡®è®¤`data.selection`ä¸æ˜¯`undefined`

---

### é—®é¢˜4: åç«¯ä¿å­˜åï¼Œæœ€ç»ˆè¿”å›çš„æ•°æ®è¿˜æ˜¯ç©º

**å¯èƒ½åŸå› **:
- çŠ¶æ€æ²¡æœ‰æ­£ç¡®æŒä¹…åŒ–
- ä¸åŒçš„session_id

**è§£å†³**:
- æ£€æŸ¥session_idæ˜¯å¦ä¸€è‡´
- æŸ¥çœ‹`state.user_selections`æ˜¯å¦æ­£ç¡®ä¿å­˜

---

## ğŸ“ æµ‹è¯•æ¸…å•

ä½¿ç”¨ä»¥ä¸‹æ¸…å•é€æ­¥æµ‹è¯•ï¼š

### äº¤é€šé€‰æ‹©æµ‹è¯•

- [ ] æ‰“å¼€Console
- [ ] ç‚¹å‡»ä¸€ä¸ªäº¤é€šå¡ç‰‡ï¼ˆåº”è¯¥é«˜äº®ï¼‰
- [ ] ç‚¹å‡»"ç¡®è®¤é€‰æ‹©"æŒ‰é’®
- [ ] Consoleæ˜¾ç¤º: `ğŸ¯ [ChatView] handleSelectionè¢«è°ƒç”¨`
- [ ] Consoleæ˜¾ç¤º: `ğŸ“¦ [ChatView] selectionData` åŒ…å«å®Œæ•´æ•°æ®
- [ ] Consoleæ˜¾ç¤º: `ğŸŒ [API] sendMessageè¢«è°ƒç”¨`
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º: `ğŸ“¨ APIæ”¶åˆ°è¯·æ±‚`
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º: `ğŸ“¦ selectionæ•°æ®: {'choice': {...}}`
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º: `ğŸ’¾ äº¤é€šé€‰æ‹©å·²ä¿å­˜åˆ°state`

### ä½å®¿é€‰æ‹©æµ‹è¯•

- [ ] æ‰“å¼€Console
- [ ] ç‚¹å‡»ä¸€ä¸ªé…’åº—å¡ç‰‡ï¼ˆåº”è¯¥é«˜äº®ï¼‰
- [ ] Consoleæ˜¾ç¤º: `ğŸ¨ å‘é€ä½å®¿é€‰æ‹©:`
- [ ] ç‚¹å‡»"ç¡®è®¤é€‰æ‹©"æŒ‰é’®
- [ ] Consoleæ˜¾ç¤ºå®Œæ•´çš„é€‰æ‹©æ•°æ®
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤ºä½å®¿æ•°æ®è¢«ä¿å­˜
- [ ] æœ€ç»ˆè¿”å›çš„`itinerary.hotel`ä¸æ˜¯ç©ºå¯¹è±¡

---

**æ›´æ–°æ—¶é—´**: 2025-11-19  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… æ—¥å¿—å·²æ·»åŠ ï¼Œç­‰å¾…æµ‹è¯•

